<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Integrations | Coastal Debt CMS</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/style.css?v=5">
  <style>
    .settings-card {
      background: #fff;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .settings-card h3 {
      margin: 0 0 8px 0;
      font-size: 18px;
    }
    .settings-card p {
      color: #6b7280;
      margin: 0 0 20px 0;
    }
    .connection-status {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 16px;
    }
    .connection-status.connected {
      background: #d1fae5;
      border: 1px solid #10b981;
    }
    .connection-status.disconnected {
      background: #fef3c7;
      border: 1px solid #f59e0b;
    }
    .status-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }
    .status-dot.green { background: #10b981; }
    .status-dot.yellow { background: #f59e0b; }
    .account-info {
      flex: 1;
    }
    .account-info strong {
      display: block;
      margin-bottom: 4px;
    }
    .account-info span {
      color: #6b7280;
      font-size: 14px;
    }
    .cost-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-top: 20px;
    }
    .stat-card {
      background: #f9fafb;
      border-radius: 8px;
      padding: 16px;
      text-align: center;
    }
    .stat-card .value {
      font-size: 28px;
      font-weight: 700;
      color: #1f2937;
    }
    .stat-card .label {
      color: #6b7280;
      font-size: 14px;
      margin-top: 4px;
    }
    .setup-steps {
      background: #f9fafb;
      border-radius: 8px;
      padding: 20px;
      margin-top: 16px;
    }
    .setup-steps h4 {
      margin: 0 0 12px 0;
    }
    .setup-steps ol {
      margin: 0;
      padding-left: 20px;
    }
    .setup-steps li {
      margin-bottom: 8px;
      color: #4b5563;
    }
    .setup-steps a {
      color: #3052FF;
    }
    .accounts-dropdown {
      margin-top: 16px;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-logo">
        <span class="nautilus-brand">NAUTILUS</span>
        <img src="https://cdn.prod.website-files.com/6634aeab2fd552b666b69c25/68d3ea2a40971102ff6b605f_4df5ec858fd5062f2c7c25ddc701c00e_Coastal%20Debt%20Resolve_id2iMYK6Ad_1%201%20(1).svg" alt="Coastal Debt" style="height:36px;background:#fff;padding:8px 12px;border-radius:8px;">
      </div>
      <nav class="sidebar-nav">
        <a href="/admin/">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
          Dashboard
        </a>
        <a href="/admin/leads.html">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg>
          Leads
        </a>
        <a href="/admin/pipeline.html">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
          Pipeline
        </a>
        <a href="/admin/email-campaigns.html">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
          Email Marketing
        </a>
        <a href="/admin/visitors.html">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
          Visitors
        </a>
        <a href="/admin/conversions.html">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
          Conversions
        </a>
        <a href="/admin/campaigns.html">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3h18v4H3z"/><path d="M3 10h12v4H3z"/><path d="M3 17h8v4H3z"/></svg>
          Campaigns
        </a>
        <button class="nav-group-toggle" onclick="this.classList.toggle('open');this.nextElementSibling.classList.toggle('open')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10 15.3 15.3 0 014-10z"/></svg>
          Webleads
          <svg class="nav-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
        </button>
        <div class="nav-submenu">
          <a href="/admin/google-ads.html">Google Ads</a>
          <a href="/admin/bing-ads.html">Bing Ads</a>
          <a href="/admin/meta-ads.html">Meta Ads</a>
          <a href="/admin/tiktok.html">TikTok</a>
          <a href="/admin/outbrain.html">Outbrain</a>
          <a href="/admin/reddit.html">Reddit</a>
          <a href="/admin/facebook-debug.html">FB Debug</a>
          <a href="/admin/fb-deep-events.html">FB Deep Events</a>
          <a href="/admin/tiktok-debug.html">TikTok Debug</a>
        </div>
        <a href="/admin/redtrack.html">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>
          RedTrack
        </a>
        <a href="/admin/google-sheet.html">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M3 15h18M9 3v18"/></svg>
          Google Sheet
        </a>
        <a href="/admin/utm-builder.html">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"/></svg>
          UTM Builder
        </a>
        <a href="/admin/organic.html">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M2 12h20"/><path d="M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10 15.3 15.3 0 014-10z"/></svg>
          Organic Traffic
        </a>
        <a href="/admin/pages.html">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
          Landing Pages
        </a>
        <a href="/admin/articles.html">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 22h16a2 2 0 002-2V4a2 2 0 00-2-2H8a2 2 0 00-2 2v16a2 2 0 01-2 2zm0 0a2 2 0 01-2-2v-9c0-1.1.9-2 2-2h2"/><line x1="10" y1="6" x2="18" y2="6"/><line x1="10" y1="10" x2="18" y2="10"/><line x1="10" y1="14" x2="14" y2="14"/></svg>
          Articles
        </a>
        <a href="/admin/forms.html">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M9 9h6M9 13h6M9 17h4"/></svg>
          Forms
        </a>
        <a href="/admin/scripts.html">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>
          Scripts
        </a>
        <a href="/admin/settings.html" class="active">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
          Integrations
        </a>
        <a href="/admin/platform-settings.html">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12.22 2h-.44a2 2 0 00-2 2v.18a2 2 0 01-1 1.73l-.43.25a2 2 0 01-2 0l-.15-.08a2 2 0 00-2.73.73l-.22.38a2 2 0 00.73 2.73l.15.1a2 2 0 011 1.72v.51a2 2 0 01-1 1.74l-.15.09a2 2 0 00-.73 2.73l.22.38a2 2 0 002.73.73l.15-.08a2 2 0 012 0l.43.25a2 2 0 011 1.73V20a2 2 0 002 2h.44a2 2 0 002-2v-.18a2 2 0 011-1.73l.43-.25a2 2 0 012 0l.15.08a2 2 0 002.73-.73l.22-.39a2 2 0 00-.73-2.73l-.15-.08a2 2 0 01-1-1.74v-.5a2 2 0 011-1.74l.15-.09a2 2 0 00.73-2.73l-.22-.38a2 2 0 00-2.73-.73l-.15.08a2 2 0 01-2 0l-.43-.25a2 2 0 01-1-1.73V4a2 2 0 00-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
          Settings
        </a>
      </nav>
      <div class="sidebar-footer">
        <div class="user-info">
          <div class="user-avatar" id="userAvatar">A</div>
          <div>
            <div class="user-name" id="userName">Admin</div>
            <div class="user-email" id="userEmail">admin@example.com</div>
          </div>
        </div>
        <button class="btn btn-secondary btn-small" onclick="logout()" style="width: 100%;">Logout</button>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <div class="page-header">
        <h1>Integrations</h1>
      </div>

      <!-- Google Ads Connection -->
      <div class="settings-card">
        <h3>Google Ads Integration</h3>
        <p>Connect your Google Ads account to track cost per lead and campaign performance.</p>

        <div id="connectionStatus">
          <div class="connection-status disconnected">
            <div class="status-dot yellow"></div>
            <div class="account-info">
              <strong>Not Connected</strong>
              <span>Connect your Google Ads account to see cost data</span>
            </div>
          </div>
        </div>

        <!-- Connect Button -->
        <div id="connectSection" style="margin-top: 16px;">
          <button class="btn btn-primary" onclick="connectGoogleAds()">Connect Google Ads Account</button>
        </div>

        <!-- Account Selection (shown after OAuth) -->
        <div id="accountSelection" class="accounts-dropdown" style="display: none;">
          <div class="form-group">
            <label>Select Google Ads Account</label>
            <select id="accountSelect">
              <option value="">Loading accounts...</option>
            </select>
          </div>
          <button class="btn btn-primary" onclick="selectAccount()">Use This Account</button>
        </div>

        <!-- MCC / Login Customer ID -->
        <div id="mccSection" style="display: none; margin-top: 16px;">
          <div class="form-group" style="max-width: 400px;">
            <label>MCC Account ID <span style="color:#6b7280;font-weight:normal;">(Manager Account)</span></label>
            <div style="display: flex; gap: 8px;">
              <input type="text" id="mccInput" placeholder="e.g. 8504676688" style="flex:1;">
              <button class="btn btn-secondary" onclick="saveMcc()">Save</button>
            </div>
            <small style="color:#6b7280;">Required if you access this account through an MCC. Enter the Manager account ID.</small>
          </div>
        </div>

        <!-- Disconnect Button -->
        <div id="disconnectSection" style="display: none; margin-top: 16px;">
          <button class="btn btn-danger" onclick="disconnectGoogleAds()">Disconnect Google Ads</button>
        </div>

        <!-- Cost Statistics -->
        <div id="costStats" style="display: none;">
          <h4 style="margin-top: 24px; margin-bottom: 16px;">Cost Performance (Last 30 Days)</h4>
          <div class="cost-stats">
            <div class="stat-card">
              <div class="value" id="totalSpend">$0</div>
              <div class="label">Total Spend</div>
            </div>
            <div class="stat-card">
              <div class="value" id="avgCpl">$0</div>
              <div class="label">Avg Cost Per Lead</div>
            </div>
            <div class="stat-card">
              <div class="value" id="leadsWithCost">0</div>
              <div class="label">Leads with Cost Data</div>
            </div>
            <div class="stat-card">
              <div class="value" id="totalLeads">0</div>
              <div class="label">Total Leads</div>
            </div>
          </div>
          <div style="margin-top: 16px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
            <button class="btn btn-secondary" onclick="fetchAllCosts()">Fetch Missing Costs</button>
            <button class="btn btn-secondary" onclick="diagnoseGoogleAds()" style="background:#f3f4f6;color:#374151;">Diagnose Connection</button>
            <span id="fetchStatus" style="margin-left: 4px; color: #6b7280;"></span>
          </div>
          <div id="diagnoseResult" style="display:none; margin-top:12px; padding:16px; background:#f9fafb; border-radius:8px; font-size:13px; font-family:monospace; white-space:pre-wrap; border:1px solid #e5e7eb;"></div>
        </div>

        <!-- Setup Instructions -->
        <div class="setup-steps" id="setupSteps">
          <h4>How to Connect</h4>
          <p style="color: #6b7280; margin-bottom: 8px;">Click "Connect Google Ads Account" above, sign in with your Google account, and select the ads account you want to use. That's it!</p>
        </div>
      </div>

      <!-- Bing Ads Integration -->
      <div class="settings-card">
        <h3>Bing Ads Integration</h3>
        <p>Connect your Microsoft Advertising account to upload offline conversions via msclkid.</p>

        <div id="bingConnectionStatus">
          <div class="connection-status disconnected">
            <div class="status-dot yellow"></div>
            <div class="account-info">
              <strong>Not Connected</strong>
              <span>Connect your Bing Ads account to send conversions</span>
            </div>
          </div>
        </div>

        <!-- Connect Button -->
        <div id="bingConnectSection" style="margin-top: 16px;">
          <button class="btn btn-primary" onclick="connectBingAds()">Connect Bing Ads Account</button>
        </div>

        <!-- Account Details (shown after OAuth) -->
        <div id="bingAccountSection" style="display: none; margin-top: 16px;">
          <div class="form-group">
            <label>Account ID</label>
            <input type="text" id="bingAccountId" placeholder="Enter your Bing Ads Account ID">
          </div>
          <div class="form-group">
            <label>Customer ID</label>
            <input type="text" id="bingCustomerId" placeholder="Enter your Customer ID">
          </div>
          <div class="form-group">
            <label>Account Name</label>
            <input type="text" id="bingAccountName" placeholder="Enter account display name">
          </div>
          <button class="btn btn-primary" onclick="saveBingAccount()">Save Account Details</button>
          <span id="bingAccountStatus" style="margin-left: 12px; color: #6b7280;"></span>
        </div>

        <!-- UET Tag ID (shown after connected) -->
        <div id="bingUetSection" style="display: none; margin-top: 16px;">
          <div class="form-group">
            <label>UET Tag ID</label>
            <input type="text" id="bingUetTagId" placeholder="Enter your UET Tag ID">
            <small style="color: #666;">Find it in Microsoft Advertising &rarr; Conversion Tracking &rarr; UET Tags</small>
          </div>
          <button class="btn btn-secondary" onclick="saveBingUetTag()">Save UET Tag</button>
          <span id="bingUetStatus" style="margin-left: 12px; color: #6b7280;"></span>
        </div>

        <!-- Disconnect Button -->
        <div id="bingDisconnectSection" style="display: none; margin-top: 16px;">
          <button class="btn btn-danger" onclick="disconnectBingAds()">Disconnect Bing Ads</button>
        </div>

        <!-- Setup Instructions -->
        <div class="setup-steps" id="bingSetupSteps" style="margin-top: 16px;">
          <h4>Setup Instructions</h4>
          <ol>
            <li>Go to <a href="https://portal.azure.com/#blade/Microsoft_AAD_RegisteredApps/ApplicationsListBlade" target="_blank">Azure App Registrations</a> and register a new application</li>
            <li>Set the redirect URI to: <code id="bingRedirectUri">http://localhost:3000/api/bing-ads/callback</code></li>
            <li>Under "Certificates & Secrets", create a new client secret</li>
            <li>Under "API Permissions", add <code>https://ads.microsoft.com/msads.manage</code></li>
            <li>Set environment variables: <code>BING_ADS_CLIENT_ID</code>, <code>BING_ADS_CLIENT_SECRET</code>, <code>BING_ADS_REDIRECT_URI</code></li>
            <li>Click "Connect Bing Ads Account" above to authorize</li>
            <li>After connecting, enter your Account ID, Customer ID, and UET Tag ID</li>
          </ol>
        </div>
      </div>

      <!-- Salesforce CRM Integration -->
      <div class="settings-card">
        <h3>Salesforce CRM Integration</h3>
        <p>Auto-push new leads to Salesforce as Lead objects and receive status updates via postback.</p>

        <div id="sfConnectionStatus">
          <div class="connection-status disconnected">
            <div class="status-dot yellow"></div>
            <div class="account-info">
              <strong>Not Connected</strong>
              <span>Configure your Salesforce Connected App to start pushing leads</span>
            </div>
          </div>
        </div>

        <!-- Configuration Form -->
        <div style="margin-top: 16px;">
          <div class="form-group">
            <label>Client ID (Consumer Key)</label>
            <input type="text" id="sfClientId" placeholder="Enter Salesforce Connected App Consumer Key">
          </div>
          <div class="form-group">
            <label>Client Secret (Consumer Secret)</label>
            <input type="password" id="sfClientSecret" placeholder="Enter Consumer Secret">
          </div>
          <div class="form-group" style="display: flex; align-items: center; gap: 8px;">
            <input type="checkbox" id="sfEnabled" checked>
            <label for="sfEnabled" style="margin: 0;">Auto-push new leads to Salesforce</label>
          </div>
          <button class="btn btn-primary" onclick="saveSfConfig()">Save Configuration</button>
          <span id="sfSaveStatus" style="margin-left: 12px; color: #6b7280;"></span>
        </div>

        <!-- Connect / Test / Push Buttons -->
        <div style="margin-top: 16px; display: flex; gap: 8px; flex-wrap: wrap;">
          <button class="btn btn-primary" id="sfConnectBtn" onclick="connectSalesforce()">Connect with Salesforce</button>
          <button class="btn btn-secondary" onclick="testSfConnection()">Test Connection</button>
          <button class="btn btn-secondary" onclick="pushAllToSf()">Push All Unpushed Leads</button>
        </div>

        <!-- Disconnect (shown when connected) -->
        <div id="sfDisconnectSection" style="display: none; margin-top: 16px;">
          <div id="sfInstanceUrl" style="color: #6b7280; margin-bottom: 8px;"></div>
          <button class="btn btn-danger" onclick="disconnectSalesforce()">Disconnect Salesforce</button>
        </div>

        <!-- Callback URL -->
        <div style="margin-top: 16px;">
          <div class="form-group">
            <label>OAuth Callback URL <small>(use this in your Salesforce Connected App)</small></label>
            <div style="display: flex; gap: 8px;">
              <input type="text" id="sfCallbackUrl" readonly style="background: #f3f4f6;">
              <button class="btn btn-secondary" onclick="navigator.clipboard.writeText(document.getElementById('sfCallbackUrl').value).then(() => alert('Copied!'))">Copy</button>
            </div>
          </div>
        </div>

        <!-- Setup Instructions -->
        <div class="setup-steps" id="sfSetupSteps" style="margin-top: 16px;">
          <h4>Setup Instructions</h4>
          <ol>
            <li>In Salesforce, go to <strong>Setup → App Manager → New Connected App</strong></li>
            <li>Set <strong>Connected App Name</strong> (e.g., "CMS Integration")</li>
            <li>Check <strong>Enable OAuth Settings</strong></li>
            <li>Set the <strong>Callback URL</strong> to the value shown above</li>
            <li>Add OAuth Scopes: <code>Manage user data via APIs (api)</code> and <code>Perform requests at any time (refresh_token)</code></li>
            <li>Save, then wait 2-10 minutes for Salesforce to activate the app</li>
            <li>Copy the <strong>Consumer Key</strong> and <strong>Consumer Secret</strong> into the fields above</li>
            <li>Click <strong>Save Configuration</strong>, then <strong>Connect with Salesforce</strong></li>
            <li>After connecting, click <strong>Test Connection</strong> to verify Lead access</li>
          </ol>
        </div>
      </div>

      <!-- Meta (Facebook) Integration -->
      <div class="settings-card">
        <h3>Meta (Facebook) Integration</h3>
        <p>Connect Facebook to receive leads from Instant Forms (Lead Ads).</p>

        <div id="fbConnectionStatus">
          <div class="connection-status disconnected">
            <div class="status-dot yellow"></div>
            <div class="account-info">
              <strong>Not Configured</strong>
              <span>Set up your Page Access Token to receive instant form leads</span>
            </div>
          </div>
        </div>

        <!-- Webhook URL (read-only) -->
        <div class="form-group" style="margin-bottom: 16px;">
          <label>Webhook URL</label>
          <div style="display: flex; gap: 8px;">
            <input type="text" id="fbWebhookUrl" readonly style="flex: 1; background: #f9fafb; font-family: monospace; font-size: 13px;">
            <button class="btn btn-secondary" onclick="copyFbWebhook()">Copy</button>
          </div>
          <small style="color: #666;">Use this URL in your Facebook App's Webhooks settings</small>
        </div>

        <!-- Config Form -->
        <div class="form-group">
          <label>User Access Token <span style="color:#10b981;font-size:11px;">(Multi-Page Sync)</span></label>
          <input type="password" id="fbUserToken" placeholder="Enter your Facebook User Access Token">
          <small style="color: #666;">Optional. Enables syncing leads from ALL your Facebook pages. Get it from <a href="https://developers.facebook.com/tools/explorer/" target="_blank">Graph API Explorer</a> with <code>leads_retrieval</code>, <code>pages_show_list</code>, and <code>pages_read_engagement</code> permissions</small>
        </div>

        <div class="form-group">
          <label>Page Access Token</label>
          <input type="password" id="fbPageToken" placeholder="Enter your Facebook Page Access Token">
          <small style="color: #666;">Used for CAPI events and single-page fallback. Get it from <a href="https://developers.facebook.com/tools/explorer/" target="_blank">Graph API Explorer</a> with <code>leads_retrieval</code> and <code>pages_manage_ads</code> permissions</small>
        </div>

        <div class="form-group">
          <label>App ID</label>
          <input type="text" id="fbAppId" placeholder="Enter your Facebook App ID">
          <small style="color: #666;">Required for page discovery with Business Manager pages. Find it in <a href="https://developers.facebook.com/apps/" target="_blank">App Settings</a> &rarr; Basic</small>
        </div>

        <div class="form-group">
          <label>App Secret</label>
          <input type="password" id="fbAppSecret" placeholder="Enter your Facebook App Secret">
          <small style="color: #666;">Required for page discovery. Find it in <a href="https://developers.facebook.com/apps/" target="_blank">App Settings</a> &rarr; Basic &rarr; Show</small>
        </div>

        <div class="form-group">
          <label>Webhook Verify Token</label>
          <input type="text" id="fbVerifyToken" placeholder="A secret token to verify webhook requests">
          <small style="color: #666;">Enter any random string. You'll use the same value when setting up the webhook in Facebook App</small>
        </div>

        <div class="form-group">
          <label>Pixel ID</label>
          <input type="text" id="fbPixelId" placeholder="Enter your Facebook Pixel ID">
          <small style="color: #666;">Required for Conversions API (CAPI). Find it in <a href="https://business.facebook.com/events_manager" target="_blank">Events Manager</a> &rarr; Data Sources</small>
        </div>

        <div class="form-group">
          <label>Ad Account ID</label>
          <input type="text" id="fbAdAccountId" placeholder="act_123456789">
          <small style="color: #666;">Required for cost stats. Find it in <a href="https://business.facebook.com/adsmanager" target="_blank">Ads Manager</a> &rarr; Account Overview. Format: <code>act_XXXXXXXXX</code></small>
        </div>

        <div class="form-group">
          <label>Test Event Code</label>
          <input type="text" id="fbTestEventCode" placeholder="TEST12345">
          <small style="color: #666;">Optional. Used for testing CAPI events. Find it in <a href="https://business.facebook.com/events_manager" target="_blank">Events Manager</a> &rarr; Test Events tab. Remove when done testing.</small>
        </div>

        <div class="form-group">
          <label>Default Landing Page for Instant Form Leads</label>
          <select id="fbDefaultPage">
            <option value="">Select a landing page...</option>
          </select>
          <small style="color: #666;">Facebook instant form leads will be associated with this landing page</small>
        </div>

        <div style="display: flex; gap: 12px; margin-top: 16px; flex-wrap: wrap;">
          <button class="btn btn-primary" onclick="saveFbConfig()">Save Configuration</button>
          <button class="btn btn-secondary" onclick="testFbConnection()">Test Connection</button>
          <button class="btn btn-secondary" onclick="syncFbNow()" id="fbSyncBtn">Sync Leads Now</button>
        </div>
        <span id="fbSaveStatus" style="margin-left: 12px; color: #6b7280;"></span>

        <!-- Facebook Cost Statistics -->
        <div id="fbCostStats" style="display: none;">
          <h4 style="margin-top: 24px; margin-bottom: 16px;">Ad Spend (Last 30 Days)</h4>
          <div class="cost-stats">
            <div class="stat-card">
              <div class="value" id="fbTotalSpend">$0</div>
              <div class="label">Total Spend</div>
            </div>
            <div class="stat-card">
              <div class="value" id="fbAvgCpl">$0</div>
              <div class="label">Avg Cost Per Lead</div>
            </div>
            <div class="stat-card">
              <div class="value" id="fbFbLeads">0</div>
              <div class="label">Facebook-reported Leads</div>
            </div>
            <div class="stat-card">
              <div class="value" id="fbLocalLeads">0</div>
              <div class="label">Local CMS Leads</div>
            </div>
          </div>
          <div style="margin-top: 16px;">
            <button class="btn btn-secondary" onclick="refreshFbStats()">Refresh Stats</button>
            <span id="fbStatsStatus" style="margin-left: 12px; color: #6b7280;"></span>
          </div>
        </div>

        <!-- Setup Instructions -->
        <div class="setup-steps" style="margin-top: 20px;">
          <h4>Setup Instructions</h4>
          <ol>
            <li>Go to <a href="https://developers.facebook.com/apps/" target="_blank">Facebook Developers</a> and create an App (type: Business)</li>
            <li>Add the "Webhooks" product to your app</li>
            <li>Subscribe to the <strong>Page</strong> object, <strong>leadgen</strong> field</li>
            <li>Set Callback URL to the Webhook URL above and the Verify Token to match your setting</li>
            <li>Go to <a href="https://developers.facebook.com/tools/explorer/" target="_blank">Graph API Explorer</a>, select your app and page</li>
            <li>Generate a Page Access Token with <code>leads_retrieval</code> and <code>pages_manage_ads</code> permissions</li>
            <li>For a non-expiring token, exchange the short-lived token for a long-lived one via the API</li>
            <li>Paste the token above and save</li>
          </ol>
        </div>
      </div>
      <!-- TikTok Lead Gen Integration -->
      <div class="settings-card">
        <h3>TikTok Lead Gen Integration</h3>
        <p>Import leads from TikTok Lead Generation forms directly into the CMS.</p>

        <div id="ttConnectionStatus">
          <div class="connection-status disconnected">
            <div class="status-dot yellow"></div>
            <div class="account-info">
              <strong>Not Configured</strong>
              <span>Set up your App credentials and connect via OAuth to import TikTok leads</span>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label>App ID</label>
          <input type="text" id="ttAppId" placeholder="Enter your TikTok App ID">
          <small style="color: #666;">From <a href="https://business-api.tiktok.com/portal/apps/" target="_blank">TikTok Developer Portal</a> &rarr; My Apps</small>
        </div>

        <div class="form-group">
          <label>App Secret</label>
          <input type="password" id="ttAppSecret" placeholder="Enter your TikTok App Secret">
          <small style="color: #666;">Found under your app details in the developer portal</small>
        </div>

        <div class="form-group">
          <label>Advertiser ID</label>
          <input type="text" id="ttAdvertiserId" placeholder="Enter your TikTok Advertiser ID">
          <small style="color: #666;">Find it in TikTok Ads Manager &rarr; Account Info. Numeric ID like <code>7123456789012345678</code></small>
        </div>

        <div class="form-group">
          <label>Default Landing Page for TikTok Leads</label>
          <select id="ttDefaultPage">
            <option value="">Select a landing page...</option>
          </select>
          <small style="color: #666;">TikTok lead gen leads will be associated with this landing page</small>
        </div>

        <div class="form-group">
          <label>Access Token</label>
          <input type="password" id="ttAccessToken" placeholder="Auto-filled after OAuth connection" readonly style="background: #f3f4f6;">
          <small style="color: #666;">Automatically set when you connect via OAuth below</small>
        </div>

        <div style="display: flex; gap: 12px; margin-top: 16px; flex-wrap: wrap; align-items: center;">
          <button class="btn btn-primary" onclick="saveTikTokConfig()">Save Configuration</button>
          <button class="btn btn-secondary" onclick="connectTikTok()" id="ttConnectBtn" style="background: #00f2ea; color: #000; border-color: #00f2ea;">Connect with TikTok</button>
          <button class="btn btn-secondary" onclick="syncTikTokNow()" id="ttSyncBtn">Sync Leads Now</button>
        </div>
        <span id="ttSaveStatus" style="margin-left: 12px; color: #6b7280;"></span>

        <div class="form-group" style="margin-top: 20px;">
          <label>Webhook URL (for TikTok Instant Form leads)</label>
          <div style="display: flex; gap: 8px;">
            <input type="text" id="ttWebhookUrl" readonly style="background: #f3f4f6; font-family: monospace; font-size: 13px;">
            <button class="btn btn-secondary" onclick="navigator.clipboard.writeText(document.getElementById('ttWebhookUrl').value); this.textContent='Copied!'; setTimeout(() => this.textContent='Copy', 1500)" style="white-space: nowrap;">Copy</button>
          </div>
          <small style="color: #666;">Paste this URL in TikTok Ads Manager &rarr; Lead Gen Form &rarr; CRM &rarr; <strong>Custom API</strong> &rarr; Webhook URL</small>
        </div>

        <div class="setup-steps" style="margin-top: 20px;">
          <h4>Setup Instructions</h4>
          <ol>
            <li>Enter your <strong>App ID</strong> and <strong>App Secret</strong> from the <a href="https://business-api.tiktok.com/portal/apps/" target="_blank">TikTok Developer Portal</a></li>
            <li>Enter your <strong>Advertiser ID</strong> and select a <strong>Default Landing Page</strong> (optional)</li>
            <li>Click <strong>Save Configuration</strong>, then <strong>Connect with TikTok</strong></li>
            <li>Copy the <strong>Webhook URL</strong> above</li>
            <li>In TikTok Ads Manager, edit your Lead Gen form &rarr; CRM Integration &rarr; <strong>Custom API</strong> &rarr; paste the webhook URL</li>
            <li>New leads from the instant form will appear in the CMS instantly</li>
          </ol>
        </div>
      </div>

      <!-- Inbound Webhooks -->
      <div class="settings-card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
          <div>
            <h3 style="margin:0;">Inbound Webhooks</h3>
            <p style="margin:4px 0 0;">Receive leads from Zapier, Make, or any external platform</p>
          </div>
          <button class="btn btn-primary" onclick="openWebhookModal()">+ New Webhook</button>
        </div>

        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Name</th>
                <th>Platform</th>
                <th>Landing Page</th>
                <th>Webhook URL</th>
                <th>Leads</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="webhookTable">
              <tr><td colspan="7" style="text-align:center;padding:30px;color:#9ca3af;">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Webhook Modal -->
      <div class="modal-overlay" id="webhookModal">
        <div class="modal" style="max-width:700px;">
          <div class="modal-header">
            <h2 id="webhookModalTitle">New Webhook</h2>
            <button class="modal-close" onclick="hideModal('webhookModal')">&times;</button>
          </div>
          <form onsubmit="saveWebhook(event)">
            <input type="hidden" id="whId">
            <div class="form-group">
              <label>Webhook Name <span style="color:red">*</span></label>
              <input type="text" id="whName" required placeholder="e.g. Facebook Instant Forms - Zapier">
            </div>
            <div class="form-group">
              <label>Platform <span style="color:red">*</span></label>
              <select id="whPlatform" required>
                <option value="facebook">Facebook / Meta</option>
                <option value="google">Google</option>
                <option value="bing">Bing</option>
                <option value="tiktok">TikTok</option>
                <option value="linkedin">LinkedIn</option>
                <option value="other">Other</option>
              </select>
            </div>
            <div class="form-group">
              <label>Landing Page</label>
              <select id="whLandingPage">
                <option value="">Auto-detect (uses platform default)</option>
              </select>
            </div>
            <div class="form-group">
              <label>Active</label>
              <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                <input type="checkbox" id="whActive" checked> Receive leads on this webhook
              </label>
            </div>

            <h3 style="margin:24px 0 8px;font-size:15px;border-top:1px solid #e5e7eb;padding-top:16px;">Field Mapping</h3>
            <p style="color:#6b7280;font-size:13px;margin:0 0 12px;">Map incoming field names to CMS fields. Leave empty for auto-detect.</p>

            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
              <div class="form-group">
                <label>First Name field</label>
                <input type="text" id="mapFirstName" placeholder="e.g. first_name (auto-detect)">
              </div>
              <div class="form-group">
                <label>Last Name field</label>
                <input type="text" id="mapLastName" placeholder="e.g. last_name (auto-detect)">
              </div>
              <div class="form-group">
                <label>Email field</label>
                <input type="text" id="mapEmail" placeholder="e.g. email (auto-detect)">
              </div>
              <div class="form-group">
                <label>Phone field</label>
                <input type="text" id="mapPhone" placeholder="e.g. phone_number (auto-detect)">
              </div>
              <div class="form-group">
                <label>Company field</label>
                <input type="text" id="mapCompany" placeholder="e.g. company_name (auto-detect)">
              </div>
              <div class="form-group">
                <label>Debt Amount field</label>
                <input type="text" id="mapDebt" placeholder="e.g. debt_amount (auto-detect)">
              </div>
              <div class="form-group">
                <label>Has MCA field</label>
                <input type="text" id="mapMca" placeholder="e.g. has_mca (auto-detect)">
              </div>
              <div class="form-group">
                <label>Lead ID field</label>
                <input type="text" id="mapLeadgenId" placeholder="e.g. id (auto-detect)">
              </div>
              <div class="form-group">
                <label>Form Name field</label>
                <input type="text" id="mapFormName" placeholder="e.g. form_name (auto-detect)">
              </div>
            </div>

            <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:16px;">
              <button type="button" class="btn btn-secondary" onclick="hideModal('webhookModal')">Cancel</button>
              <button type="submit" class="btn btn-primary">Save Webhook</button>
            </div>
          </form>
        </div>
      </div>

    </main>
  </div>

  <script src="assets/js/common.js?v=6"></script>
  <script>
    // --- Facebook Config ---
    async function loadFbConfig() {
      // Set webhook URL
      const baseUrl = window.location.origin;
      document.getElementById('fbWebhookUrl').value = baseUrl + '/api/facebook/webhook';

      // Load landing pages for dropdown
      try {
        const pagesRes = await api('/api/pages');
        const select = document.getElementById('fbDefaultPage');
        (pagesRes.pages || pagesRes).forEach(p => {
          const opt = document.createElement('option');
          opt.value = p.id;
          opt.textContent = p.name + ' (' + p.platform + ')';
          select.appendChild(opt);
        });
      } catch (e) {}

      // Load existing config
      try {
        const config = await api('/api/facebook/config');
        if (config.page_access_token || config.user_access_token) {
          document.getElementById('fbPageToken').value = config.page_access_token || '';
          document.getElementById('fbUserToken').value = config.user_access_token || '';
          document.getElementById('fbAppId').value = config.app_id || '';
          document.getElementById('fbAppSecret').value = config.app_secret || '';
          document.getElementById('fbVerifyToken').value = config.verify_token || '';
          document.getElementById('fbPixelId').value = config.pixel_id || '';
          document.getElementById('fbAdAccountId').value = config.ad_account_id || '';
          document.getElementById('fbTestEventCode').value = config.test_event_code || '';
          document.getElementById('fbDefaultPage').value = config.default_landing_page_id || '';

          document.getElementById('fbConnectionStatus').innerHTML = `
            <div class="connection-status connected">
              <div class="status-dot green"></div>
              <div class="account-info">
                <strong>Configured</strong>
                <span>Connected on ${config.connected_at ? formatDate(config.connected_at) : 'Unknown'}</span>
              </div>
            </div>
          `;

          // Show cost stats if ad_account_id is configured
          if (config.ad_account_id) {
            document.getElementById('fbCostStats').style.display = 'block';
            loadFbStats();
          }
        }
      } catch (e) {}
    }

    async function saveFbConfig() {
      const token = document.getElementById('fbPageToken').value;
      const userToken = document.getElementById('fbUserToken').value;
      const appId = document.getElementById('fbAppId').value;
      const appSecret = document.getElementById('fbAppSecret').value;
      const verify = document.getElementById('fbVerifyToken').value;
      const pixelId = document.getElementById('fbPixelId').value;
      const adAccountId = document.getElementById('fbAdAccountId').value;
      const testEventCode = document.getElementById('fbTestEventCode').value;
      const pageId = document.getElementById('fbDefaultPage').value;

      if (!verify) {
        alert('Verify Token is required');
        return;
      }
      if (!token && !userToken) {
        alert('At least one access token (User or Page) is required');
        return;
      }

      try {
        await api('/api/facebook/config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            page_access_token: token || null,
            user_access_token: userToken || null,
            app_id: appId || null,
            app_secret: appSecret || null,
            verify_token: verify,
            pixel_id: pixelId || null,
            ad_account_id: adAccountId || null,
            test_event_code: testEventCode || null,
            default_landing_page_id: pageId || null
          })
        });
        document.getElementById('fbSaveStatus').textContent = 'Saved!';
        document.getElementById('fbSaveStatus').style.color = '#10b981';
        loadFbConfig();
      } catch (e) {
        document.getElementById('fbSaveStatus').textContent = 'Failed to save';
        document.getElementById('fbSaveStatus').style.color = '#ef4444';
      }
    }

    async function syncFbNow() {
      const btn = document.getElementById('fbSyncBtn');
      btn.disabled = true;
      btn.textContent = 'Syncing...';
      try {
        const res = await api('/api/facebook/sync', { method: 'POST' });
        const msg = res.synced > 0 ? 'Synced ' + res.synced + ' new lead(s)!' : 'No new leads found.';
        const errMsg = res.errors?.length ? '\n\nErrors:\n' + res.errors.join('\n') : '';
        alert(msg + errMsg);
      } catch (e) {
        alert('Sync failed: ' + e.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Sync Leads Now';
      }
    }

    async function testFbConnection() {
      try {
        const res = await api('/api/facebook/test', { method: 'POST' });
        if (res.success) {
          alert(res.message || 'Lead event sent successfully!');
        } else {
          alert('Error: ' + (res.error || 'Unknown error'));
        }
      } catch (e) {
        alert('Connection test failed: ' + e.message);
      }
    }

    function copyFbWebhook() {
      const input = document.getElementById('fbWebhookUrl');
      navigator.clipboard.writeText(input.value);
      input.select();
    }

    async function loadFbStats() {
      try {
        const stats = await api('/api/facebook/stats');
        document.getElementById('fbTotalSpend').textContent = '$' + (stats.total_spend || 0).toFixed(2);
        document.getElementById('fbAvgCpl').textContent = '$' + (stats.avg_cpl || 0).toFixed(2);
        document.getElementById('fbFbLeads').textContent = stats.fb_leads || 0;
        document.getElementById('fbLocalLeads').textContent = stats.local_leads || 0;
        if (stats.fb_error) {
          document.getElementById('fbStatsStatus').textContent = 'FB API Error: ' + stats.fb_error + (stats.debug ? ' [' + stats.debug.token_type + ' token, ' + stats.debug.ad_account_id + ']' : '');
          document.getElementById('fbStatsStatus').style.color = '#ef4444';
        }
      } catch (e) {
        document.getElementById('fbStatsStatus').textContent = 'Failed to load stats';
        document.getElementById('fbStatsStatus').style.color = '#ef4444';
      }
    }

    async function refreshFbStats() {
      document.getElementById('fbStatsStatus').textContent = 'Refreshing...';
      document.getElementById('fbStatsStatus').style.color = '#6b7280';
      await loadFbStats();
      document.getElementById('fbStatsStatus').textContent = 'Updated!';
      document.getElementById('fbStatsStatus').style.color = '#10b981';
    }

    loadFbConfig();

    // --- TikTok Lead Gen ---
    // Handle TikTok OAuth redirect params
    (function checkTikTokOAuth() {
      const params = new URLSearchParams(window.location.search);
      if (params.get('tiktok_connected') === 'true') {
        history.replaceState({}, '', '/admin/settings.html');
        setTimeout(() => alert('TikTok connected successfully! Access token has been saved.'), 300);
      }
      if (params.get('tiktok_error')) {
        const err = params.get('tiktok_error');
        history.replaceState({}, '', '/admin/settings.html');
        setTimeout(() => alert('TikTok connection error: ' + err), 300);
      }
    })();

    async function loadTikTokConfig() {
      // Populate landing page dropdown
      try {
        const pagesRes = await api('/api/pages');
        const select = document.getElementById('ttDefaultPage');
        select.innerHTML = '<option value="">Select a landing page...</option>';
        (pagesRes.pages || pagesRes).forEach(p => {
          const opt = document.createElement('option');
          opt.value = p.id;
          opt.textContent = p.name + ' (' + p.platform + ')';
          select.appendChild(opt);
        });
      } catch (e) {}

      // Load webhook URL
      try {
        const wh = await api('/api/tiktok-leads/webhook-url');
        document.getElementById('ttWebhookUrl').value = wh.webhook_url || '';
      } catch (e) {}

      // Load existing config
      try {
        const config = await api('/api/tiktok-leads/config');
        document.getElementById('ttAppId').value = config.app_id || '';
        document.getElementById('ttAdvertiserId').value = config.advertiser_id || '';
        document.getElementById('ttDefaultPage').value = config.default_landing_page_id || '';

        if (config.has_app_secret) {
          document.getElementById('ttAppSecret').value = config.app_secret || '';
        }

        if (config.has_access_token) {
          document.getElementById('ttAccessToken').value = config.access_token || '';

          document.getElementById('ttConnectionStatus').innerHTML = `
            <div class="connection-status connected">
              <div class="status-dot green"></div>
              <div class="account-info">
                <strong>Connected</strong>
                <span>Connected on ${config.connected_at ? formatDate(config.connected_at) : 'Unknown'}${config.advertiser_id ? ' | Advertiser: ' + config.advertiser_id : ''}</span>
              </div>
            </div>
          `;
        }
      } catch (e) {}
    }

    async function saveTikTokConfig() {
      const appId = document.getElementById('ttAppId').value;
      const appSecret = document.getElementById('ttAppSecret').value;
      const advertiserId = document.getElementById('ttAdvertiserId').value;
      const pageId = document.getElementById('ttDefaultPage').value;
      const token = document.getElementById('ttAccessToken').value;

      if (!appId) {
        alert('App ID is required');
        return;
      }

      try {
        await api('/api/tiktok-leads/config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            app_id: appId,
            app_secret: appSecret || undefined,
            access_token: token || undefined,
            advertiser_id: advertiserId || null,
            default_landing_page_id: pageId || null
          })
        });
        document.getElementById('ttSaveStatus').textContent = 'Saved!';
        document.getElementById('ttSaveStatus').style.color = '#10b981';
        loadTikTokConfig();
      } catch (e) {
        document.getElementById('ttSaveStatus').textContent = 'Failed to save';
        document.getElementById('ttSaveStatus').style.color = '#ef4444';
      }
    }

    async function connectTikTok() {
      try {
        const res = await api('/api/tiktok-leads/connect');
        if (res.auth_url) {
          window.location.href = res.auth_url;
        } else {
          alert(res.error || 'Could not generate TikTok auth URL');
        }
      } catch (e) {
        alert('Save your App ID and App Secret first, then click Connect.');
      }
    }

    async function syncTikTokNow() {
      const btn = document.getElementById('ttSyncBtn');
      btn.disabled = true;
      btn.textContent = 'Syncing...';
      try {
        const res = await api('/api/tiktok-leads/sync', { method: 'POST' });
        const msg = res.synced > 0 ? 'Synced ' + res.synced + ' new lead(s)!' : (res.message || 'No new leads found.');
        const errMsg = res.errors?.length ? '\n\nErrors:\n' + res.errors.join('\n') : '';
        const apiErr = res.error ? '\n\nError: ' + res.error : '';
        alert(msg + errMsg + apiErr);
      } catch (e) {
        alert('Sync failed: ' + e.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Sync Leads Now';
      }
    }

    loadTikTokConfig();

    // --- Bing Ads ---
    async function checkBingStatus() {
      // Check for URL params (after Bing OAuth redirect)
      const params = new URLSearchParams(window.location.search);
      if (params.get('bing_connected') === 'true') {
        history.replaceState({}, '', '/admin/settings.html');
      }
      if (params.get('bing_error')) {
        alert('Bing connection error: ' + params.get('bing_error'));
        history.replaceState({}, '', '/admin/settings.html');
      }

      try {
        const status = await api('/api/bing-ads/status');

        const statusDiv = document.getElementById('bingConnectionStatus');
        const connectSection = document.getElementById('bingConnectSection');
        const accountSection = document.getElementById('bingAccountSection');
        const uetSection = document.getElementById('bingUetSection');
        const disconnectSection = document.getElementById('bingDisconnectSection');
        const setupSteps = document.getElementById('bingSetupSteps');

        if (status.connected && status.account_id) {
          statusDiv.innerHTML = `
            <div class="connection-status connected">
              <div class="status-dot green"></div>
              <div class="account-info">
                <strong>Connected: ${status.account_name || status.account_id}</strong>
                <span>Account: ${status.account_id} | Customer: ${status.customer_id}${status.uet_tag_id ? ' | UET: ' + status.uet_tag_id : ''}</span>
              </div>
            </div>
          `;
          connectSection.style.display = 'none';
          accountSection.style.display = 'block';
          uetSection.style.display = 'block';
          disconnectSection.style.display = 'block';
          setupSteps.style.display = 'none';
          document.getElementById('bingAccountId').value = status.account_id || '';
          document.getElementById('bingCustomerId').value = status.customer_id || '';
          document.getElementById('bingAccountName').value = status.account_name || '';
          document.getElementById('bingUetTagId').value = status.uet_tag_id || '';
        } else if (status.connected) {
          statusDiv.innerHTML = `
            <div class="connection-status disconnected">
              <div class="status-dot yellow"></div>
              <div class="account-info">
                <strong>OAuth Connected</strong>
                <span>Please enter your account details below</span>
              </div>
            </div>
          `;
          connectSection.style.display = 'none';
          accountSection.style.display = 'block';
          uetSection.style.display = 'block';
          disconnectSection.style.display = 'block';
          setupSteps.style.display = 'none';
        }
      } catch (e) {
        console.error('Failed to check Bing status:', e);
      }
    }

    async function connectBingAds() {
      try {
        const data = await api('/api/bing-ads/connect');
        if (data.error) {
          alert(data.error);
          return;
        }
        window.location.href = data.auth_url;
      } catch (e) {
        alert('Failed to initiate Bing OAuth: ' + e.message);
      }
    }

    async function saveBingAccount() {
      const accountId = document.getElementById('bingAccountId').value;
      const customerId = document.getElementById('bingCustomerId').value;
      const accountName = document.getElementById('bingAccountName').value;

      if (!accountId || !customerId) {
        alert('Account ID and Customer ID are required');
        return;
      }

      try {
        await api('/api/bing-ads/select-account', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ account_id: accountId, customer_id: customerId, account_name: accountName })
        });
        document.getElementById('bingAccountStatus').textContent = 'Saved!';
        document.getElementById('bingAccountStatus').style.color = '#10b981';
        checkBingStatus();
      } catch (e) {
        document.getElementById('bingAccountStatus').textContent = 'Failed to save';
        document.getElementById('bingAccountStatus').style.color = '#ef4444';
      }
    }

    async function saveBingUetTag() {
      const uetTagId = document.getElementById('bingUetTagId').value;
      try {
        await api('/api/bing-ads/save-uet-tag', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ uet_tag_id: uetTagId })
        });
        document.getElementById('bingUetStatus').textContent = 'Saved!';
        document.getElementById('bingUetStatus').style.color = '#10b981';
      } catch (e) {
        document.getElementById('bingUetStatus').textContent = 'Failed to save';
        document.getElementById('bingUetStatus').style.color = '#ef4444';
      }
    }

    async function disconnectBingAds() {
      if (!confirm('Are you sure you want to disconnect Bing Ads?')) return;
      await api('/api/bing-ads/disconnect', { method: 'POST' });
      location.reload();
    }

    checkBingStatus();

    // Set Bing redirect URI display
    document.getElementById('bingRedirectUri').textContent = window.location.origin + '/api/bing-ads/callback';

    // --- Google Ads ---
    async function checkStatus() {
      // Check for URL params (after OAuth redirect)
      const params = new URLSearchParams(window.location.search);
      if (params.get('connected') === 'true') {
        // Just connected, need to select account
        document.getElementById('accountSelection').style.display = 'block';
        loadAccounts();
        history.replaceState({}, '', '/admin/settings.html');
      }
      if (params.get('error')) {
        alert('Connection error: ' + params.get('error'));
        history.replaceState({}, '', '/admin/settings.html');
      }

      // Check connection status
      const statusRes = await fetch('/api/google-ads/status');
      const status = await statusRes.json();

      const statusDiv = document.getElementById('connectionStatus');
      const connectSection = document.getElementById('connectSection');
      const disconnectSection = document.getElementById('disconnectSection');
      const costStats = document.getElementById('costStats');
      const setupSteps = document.getElementById('setupSteps');
      const accountSelection = document.getElementById('accountSelection');

      if (status.connected && status.customer_id) {
        // Fully connected
        statusDiv.innerHTML = `
          <div class="connection-status connected">
            <div class="status-dot green"></div>
            <div class="account-info">
              <strong>Connected: ${status.account_name || status.customer_id}</strong>
              <span>Connected on ${formatDate(status.connected_at)}</span>
            </div>
          </div>
        `;
        connectSection.style.display = 'none';
        disconnectSection.style.display = 'block';
        costStats.style.display = 'block';
        setupSteps.style.display = 'none';
        accountSelection.style.display = 'none';
        document.getElementById('mccSection').style.display = 'block';
        loadCostStats();
        loadMcc();
      } else if (status.connected) {
        // Connected but no account selected
        statusDiv.innerHTML = `
          <div class="connection-status disconnected">
            <div class="status-dot yellow"></div>
            <div class="account-info">
              <strong>Account Selection Required</strong>
              <span>Please select which Google Ads account to use</span>
            </div>
          </div>
        `;
        connectSection.style.display = 'none';
        disconnectSection.style.display = 'block';
        accountSelection.style.display = 'block';
        loadAccounts();
      }
      // Otherwise: not connected, connect button already visible
    }

    async function connectGoogleAds() {
      const res = await fetch('/api/google-ads/connect');
      const data = await res.json();

      if (data.error) {
        alert(data.error);
        return;
      }

      // Redirect to Google OAuth
      window.location.href = data.auth_url;
    }

    async function loadAccounts() {
      const res = await fetch('/api/google-ads/accounts');
      const data = await res.json();

      const select = document.getElementById('accountSelect');

      if (data.error) {
        select.innerHTML = `<option value="">Error: ${data.error}</option>`;
        return;
      }

      if (!data.accounts || data.accounts.length === 0) {
        select.innerHTML = `<option value="">No accounts found</option>`;
        return;
      }

      select.innerHTML = data.accounts.map(acc =>
        `<option value="${acc.customer_id}" data-name="${acc.name}">${acc.name} (${acc.customer_id})</option>`
      ).join('');
    }

    async function selectAccount() {
      const select = document.getElementById('accountSelect');
      const customerId = select.value;
      const accountName = select.options[select.selectedIndex].dataset.name;

      if (!customerId) {
        alert('Please select an account');
        return;
      }

      const res = await fetch('/api/google-ads/select-account', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ customer_id: customerId, account_name: accountName })
      });

      if (res.ok) {
        checkStatus();
      } else {
        alert('Failed to select account');
      }
    }

    async function disconnectGoogleAds() {
      if (!confirm('Are you sure you want to disconnect Google Ads?')) return;

      await fetch('/api/google-ads/disconnect', { method: 'POST' });
      location.reload();
    }

    async function loadMcc() {
      try {
        const res = await fetch('/api/google-ads/mcc');
        const data = await res.json();
        document.getElementById('mccInput').value = data.login_customer_id || '';
      } catch (e) {}
    }

    async function saveMcc() {
      const id = document.getElementById('mccInput').value.trim();
      const res = await fetch('/api/google-ads/mcc', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ login_customer_id: id })
      });
      const data = await res.json();
      alert(id ? 'MCC Account ID saved: ' + data.login_customer_id : 'MCC Account ID cleared');
    }

    async function loadCostStats() {
      const res = await fetch('/api/google-ads/stats');
      const stats = await res.json();

      document.getElementById('totalSpend').textContent = '$' + ((stats.total_spend_cents || 0) / 100).toFixed(2);
      document.getElementById('avgCpl').textContent = '$' + ((stats.avg_cpl_cents || 0) / 100).toFixed(2);
      document.getElementById('leadsWithCost').textContent = stats.leads_with_cost || 0;
      document.getElementById('totalLeads').textContent = stats.total_leads || 0;
    }

    async function diagnoseGoogleAds() {
      const el = document.getElementById('diagnoseResult');
      el.style.display = 'block';
      el.textContent = 'Running diagnostics...';
      try {
        const res = await fetch('/api/google-ads/diagnose');
        const data = await res.json();
        let output = data.ok ? '✅ ALL CHECKS PASSED\n\n' : '❌ ISSUES FOUND\n\n';
        data.checks.forEach(c => {
          const icon = c.status === 'OK' ? '✅' : c.status === 'FAIL' ? '❌' : c.status === 'WARN' ? '⚠️' : 'ℹ️';
          output += icon + ' ' + c.step + ': ' + c.detail + '\n';
        });
        el.textContent = output;
      } catch(e) {
        el.textContent = '❌ Request failed: ' + e.message;
      }
    }

    async function fetchAllCosts() {
      const statusEl = document.getElementById('fetchStatus');
      statusEl.textContent = 'Fetching...';
      statusEl.style.color = '#6b7280';

      try {
        const res = await fetch('/api/google-ads/fetch-all-costs', { method: 'POST' });
        const data = await res.json();

        if (data.total === 0) {
          statusEl.textContent = 'No leads with GCLIDs found that need cost data.';
          statusEl.style.color = '#f59e0b';
        } else if (data.last_error && data.fetched === 0) {
          let msg = `Failed: ${data.last_error}`;
          if (data.debug) msg += ` | customer=${data.debug.customer_id}, mcc=${data.debug.login_customer_id}`;
          statusEl.textContent = msg;
          statusEl.style.color = '#ef4444';
        } else {
          statusEl.textContent = `Done! Fetched ${data.fetched} of ${data.total} leads` +
            (data.failed ? ` (${data.failed} failed${data.last_error ? ': ' + data.last_error : ''})` : '');
          statusEl.style.color = data.failed ? '#f59e0b' : '#10b981';
        }
        loadCostStats();
      } catch (e) {
        statusEl.textContent = 'Error: ' + e.message;
        statusEl.style.color = '#ef4444';
      }
    }

    checkStatus();

    // ============ INBOUND WEBHOOKS ============
    let allPages = [];

    async function loadWebhooks() {
      try {
        const pagesRes = await api('/api/pages');
        allPages = pagesRes.pages || pagesRes || [];
        // Populate landing page dropdown
        const sel = document.getElementById('whLandingPage');
        sel.innerHTML = '<option value="">Auto-detect (uses platform default)</option>';
        allPages.forEach(p => {
          sel.innerHTML += '<option value="' + p.id + '">' + p.name + ' (' + p.platform + ')</option>';
        });
      } catch (e) {}

      try {
        const webhooks = await api('/api/settings/webhooks');
        const tbody = document.getElementById('webhookTable');
        if (!webhooks.length) {
          tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:30px;color:#9ca3af;">No webhooks configured. Click "+ New Webhook" to get started.</td></tr>';
          return;
        }
        tbody.innerHTML = webhooks.map(w => {
          const statusClass = w.is_active ? 'color:#10b981' : 'color:#9ca3af';
          const statusText = w.is_active ? 'Active' : 'Inactive';
          return '<tr>' +
            '<td><strong>' + w.name + '</strong></td>' +
            '<td>' + w.platform + '</td>' +
            '<td>' + (w.landing_page_name || '<em style="color:#9ca3af">Auto</em>') + '</td>' +
            '<td><div style="max-width:250px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-family:monospace;font-size:12px;cursor:pointer;" onclick="copyWhUrl(\'' + w.webhook_url.replace(/'/g, "\\'") + '\')" title="Click to copy">' + w.webhook_url + '</div></td>' +
            '<td>' + (w.leads_received || 0) + '</td>' +
            '<td><span style="' + statusClass + ';font-weight:600;">' + statusText + '</span></td>' +
            '<td><div style="display:flex;gap:6px;">' +
              '<button class="btn btn-secondary btn-small" onclick="editWebhook(' + w.id + ')">Edit</button>' +
              '<button class="btn btn-secondary btn-small" onclick="copyWhUrl(\'' + w.webhook_url.replace(/'/g, "\\'") + '\')">Copy URL</button>' +
              '<button class="btn btn-secondary btn-small" onclick="deleteWebhook(' + w.id + ')" style="color:#ef4444;">Delete</button>' +
            '</div></td>' +
          '</tr>';
        }).join('');
      } catch (e) {
        document.getElementById('webhookTable').innerHTML = '<tr><td colspan="7" style="color:#ef4444;">Error loading webhooks</td></tr>';
      }
    }

    function copyWhUrl(url) {
      navigator.clipboard.writeText(url).then(() => alert('Webhook URL copied!'));
    }

    function openWebhookModal(data) {
      document.getElementById('whId').value = data?.id || '';
      document.getElementById('whName').value = data?.name || '';
      document.getElementById('whPlatform').value = data?.platform || 'facebook';
      document.getElementById('whLandingPage').value = data?.landing_page_id || '';
      document.getElementById('whActive').checked = data ? !!data.is_active : true;
      const m = data?.field_mapping || {};
      document.getElementById('mapFirstName').value = m.first_name || '';
      document.getElementById('mapLastName').value = m.last_name || '';
      document.getElementById('mapEmail').value = m.email || '';
      document.getElementById('mapPhone').value = m.phone || '';
      document.getElementById('mapCompany').value = m.company_name || '';
      document.getElementById('mapDebt').value = m.debt_amount || '';
      document.getElementById('mapMca').value = m.has_mca || '';
      document.getElementById('mapLeadgenId').value = m.leadgen_id || '';
      document.getElementById('mapFormName').value = m.form_name || '';
      document.getElementById('webhookModalTitle').textContent = data ? 'Edit Webhook' : 'New Webhook';
      showModal('webhookModal');
    }

    async function editWebhook(id) {
      const webhooks = await api('/api/settings/webhooks');
      const wh = webhooks.find(w => w.id === id);
      if (wh) openWebhookModal(wh);
    }

    async function saveWebhook(e) {
      e.preventDefault();
      const id = document.getElementById('whId').value;
      const data = {
        name: document.getElementById('whName').value,
        platform: document.getElementById('whPlatform').value,
        landing_page_id: document.getElementById('whLandingPage').value || null,
        is_active: document.getElementById('whActive').checked,
        field_mapping: {}
      };
      // Build field mapping (only include non-empty)
      const mappings = { first_name: 'mapFirstName', last_name: 'mapLastName', email: 'mapEmail', phone: 'mapPhone', company_name: 'mapCompany', debt_amount: 'mapDebt', has_mca: 'mapMca', leadgen_id: 'mapLeadgenId', form_name: 'mapFormName' };
      for (const [key, elId] of Object.entries(mappings)) {
        const val = document.getElementById(elId).value.trim();
        if (val) data.field_mapping[key] = val;
      }

      try {
        if (id) {
          await api('/api/settings/webhooks/' + id, { method: 'PUT', body: JSON.stringify(data) });
        } else {
          const res = await api('/api/settings/webhooks', { method: 'POST', body: JSON.stringify(data) });
          alert('Webhook created!\\n\\nWebhook URL:\\n' + res.webhook_url + '\\n\\nUse this URL in Zapier/Make as the webhook destination.');
        }
        hideModal('webhookModal');
        loadWebhooks();
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    async function deleteWebhook(id) {
      if (!confirm('Delete this webhook? Leads will stop being received.')) return;
      try {
        await api('/api/settings/webhooks/' + id, { method: 'DELETE' });
        loadWebhooks();
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    loadWebhooks();

    // --- Salesforce CRM Integration ---
    const sfCallbackUrl = window.location.origin + '/api/salesforce/callback';
    document.getElementById('sfCallbackUrl').value = sfCallbackUrl;

    async function loadSfConfig() {
      try {
        const config = await api('/api/salesforce/config');
        document.getElementById('sfClientId').value = config.client_id || '';
        if (config.has_client_secret) {
          document.getElementById('sfClientSecret').value = config.client_secret || '';
        }
        document.getElementById('sfEnabled').checked = !!config.is_enabled;

        const statusEl = document.getElementById('sfConnectionStatus');
        const disconnectEl = document.getElementById('sfDisconnectSection');
        const instanceEl = document.getElementById('sfInstanceUrl');

        if (config.is_connected) {
          statusEl.innerHTML = `
            <div class="connection-status connected">
              <div class="status-dot green"></div>
              <div class="account-info">
                <strong>Connected to Salesforce</strong>
                <span>${config.instance_url}</span>
              </div>
            </div>`;
          disconnectEl.style.display = 'block';
          instanceEl.textContent = 'Instance: ' + config.instance_url;
          document.getElementById('sfConnectBtn').style.display = 'none';
          document.getElementById('sfSetupSteps').style.display = 'none';
        } else {
          statusEl.innerHTML = `
            <div class="connection-status disconnected">
              <div class="status-dot yellow"></div>
              <div class="account-info">
                <strong>Not Connected</strong>
                <span>Configure your Salesforce Connected App to start pushing leads</span>
              </div>
            </div>`;
          disconnectEl.style.display = 'none';
          document.getElementById('sfConnectBtn').style.display = '';
          document.getElementById('sfSetupSteps').style.display = '';
        }
      } catch (err) {
        console.error('Failed to load Salesforce config:', err);
      }
    }

    async function saveSfConfig() {
      const statusEl = document.getElementById('sfSaveStatus');
      try {
        statusEl.textContent = 'Saving...';
        await api('/api/salesforce/config', {
          method: 'POST',
          body: JSON.stringify({
            client_id: document.getElementById('sfClientId').value,
            client_secret: document.getElementById('sfClientSecret').value,
            is_enabled: document.getElementById('sfEnabled').checked
          })
        });
        statusEl.textContent = 'Saved!';
        setTimeout(() => statusEl.textContent = '', 3000);
        loadSfConfig();
      } catch (err) {
        statusEl.textContent = 'Error: ' + err.message;
      }
    }

    async function connectSalesforce() {
      try {
        const res = await api('/api/salesforce/connect');
        if (res.url) window.location.href = res.url;
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    async function testSfConnection() {
      try {
        const res = await api('/api/salesforce/test', { method: 'POST' });
        alert(res.message || 'Connection successful!');
      } catch (err) {
        alert('Test failed: ' + err.message);
      }
    }

    async function pushAllToSf() {
      if (!confirm('Push all unpushed leads to Salesforce? (max 100 at a time)')) return;
      try {
        const res = await api('/api/salesforce/push-all', { method: 'POST' });
        alert(`Done! Pushed: ${res.pushed}, Failed: ${res.failed}, Total: ${res.total}`);
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    async function disconnectSalesforce() {
      if (!confirm('Disconnect Salesforce? Tokens will be cleared.')) return;
      try {
        await api('/api/salesforce/disconnect', { method: 'POST' });
        loadSfConfig();
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    // Load Salesforce config on page load
    loadSfConfig();

    // Check URL params for OAuth callback result
    const sfParams = new URLSearchParams(window.location.search);
    if (sfParams.get('sf_connected') === 'true') {
      alert('Salesforce connected successfully!');
      window.history.replaceState({}, '', window.location.pathname);
    } else if (sfParams.get('sf_error')) {
      alert('Salesforce error: ' + sfParams.get('sf_error'));
      window.history.replaceState({}, '', window.location.pathname);
    }
  </script>
</body>
</html>
