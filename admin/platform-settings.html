<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Settings | Coastal Debt CMS</title>
  <link rel="stylesheet" href="assets/css/style.css?v=2">
  <style>
    .tabs { display: flex; gap: 0; border-bottom: 2px solid var(--gray-200); margin-bottom: 24px; }
    .tab-btn { padding: 12px 24px; background: none; border: none; font-size: 0.95rem; font-weight: 500; color: var(--gray-500); cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -2px; transition: all 0.2s; }
    .tab-btn:hover { color: var(--gray-700); }
    .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .settings-form { max-width: 600px; }
    .settings-form .form-group { margin-bottom: 20px; }
    .settings-form select, .settings-form input[type="text"], .settings-form input[type="url"] {
      width: 100%; padding: 10px 14px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 0.95rem;
    }
    .settings-form select:focus, .settings-form input:focus { outline: none; border-color: var(--primary); }

    .upload-row { display: flex; gap: 8px; align-items: center; }
    .upload-row input[type="text"] { flex: 1; }
    .upload-btn { padding: 10px 16px; background: var(--gray-200); color: var(--gray-700); border: none; border-radius: 8px; cursor: pointer; font-size: 0.9rem; white-space: nowrap; }
    .upload-btn:hover { background: var(--gray-300); }

    .preview-box { margin-top: 8px; padding: 12px; background: var(--gray-50); border-radius: 8px; border: 1px solid var(--gray-200); }
    .preview-box img { max-width: 120px; max-height: 60px; }
    .preview-box.favicon img { max-width: 32px; max-height: 32px; }

    .permission-grid { display: grid; gap: 12px; }
    .permission-item { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; background: var(--gray-50); border-radius: 8px; }
    .permission-item label { font-weight: 500; color: var(--gray-700); cursor: pointer; }

    .pagination { display: flex; gap: 8px; justify-content: center; margin-top: 20px; align-items: center; }
    .pagination button { padding: 8px 14px; border: 1px solid var(--gray-300); background: var(--white); border-radius: 6px; cursor: pointer; font-size: 0.85rem; }
    .pagination button:hover:not(:disabled) { background: var(--gray-100); }
    .pagination button:disabled { opacity: 0.5; cursor: default; }
    .pagination button.active { background: var(--primary); color: var(--white); border-color: var(--primary); }
    .pagination span { color: var(--gray-500); font-size: 0.85rem; }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-logo">
        <img src="https://cdn.prod.website-files.com/6634aeab2fd552b666b69c25/68d3ea2a40971102ff6b605f_4df5ec858fd5062f2c7c25ddc701c00e_Coastal%20Debt%20Resolve_id2iMYK6Ad_1%201%20(1).svg" alt="Coastal Debt" style="height:36px;background:#fff;padding:8px 12px;border-radius:8px;">
      </div>
      <nav class="sidebar-nav">
        <a href="/admin/">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
          Dashboard
        </a>
        <a href="/admin/leads.html">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg>
          Leads
        </a>
        <a href="/admin/visitors.html">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
          Visitors
        </a>
        <a href="/admin/conversions.html">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
          Conversions
        </a>
        <a href="/admin/google-ads.html">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>
          Google Ads
        </a>
        <a href="/admin/bing-ads.html">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 3v18l5-3 9 4V4L10 0z"/></svg>
          Bing Ads
        </a>
        <a href="/admin/meta-ads.html">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 2h-3a5 5 0 00-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 011-1h3z"/></svg>
          Meta Ads
        </a>
        <a href="/admin/facebook-debug.html">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 013 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
          FB Debug
        </a>
        <a href="/admin/utm-builder.html">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"/></svg>
          UTM Builder
        </a>
        <a href="/admin/organic.html">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M2 12h20"/><path d="M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10 15.3 15.3 0 014-10z"/></svg>
          Organic Traffic
        </a>
        <a href="/admin/pages.html">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
          Landing Pages
        </a>
        <a href="/admin/forms.html">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M9 9h6M9 13h6M9 17h4"/></svg>
          Forms
        </a>
        <a href="/admin/scripts.html">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>
          Scripts
        </a>
        <a href="/admin/settings.html">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
          Integrations
        </a>
        <a href="/admin/platform-settings.html" class="active">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12.22 2h-.44a2 2 0 00-2 2v.18a2 2 0 01-1 1.73l-.43.25a2 2 0 01-2 0l-.15-.08a2 2 0 00-2.73.73l-.22.38a2 2 0 00.73 2.73l.15.1a2 2 0 011 1.72v.51a2 2 0 01-1 1.74l-.15.09a2 2 0 00-.73 2.73l.22.38a2 2 0 002.73.73l.15-.08a2 2 0 012 0l.43.25a2 2 0 011 1.73V20a2 2 0 002 2h.44a2 2 0 002-2v-.18a2 2 0 011-1.73l.43-.25a2 2 0 012 0l.15.08a2 2 0 002.73-.73l.22-.39a2 2 0 00-.73-2.73l-.15-.08a2 2 0 01-1-1.74v-.5a2 2 0 011-1.74l.15-.09a2 2 0 00.73-2.73l-.22-.38a2 2 0 00-2.73-.73l-.15.08a2 2 0 01-2 0l-.43-.25a2 2 0 01-1-1.73V4a2 2 0 00-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
          Settings
        </a>
      </nav>
      <div class="sidebar-footer">
        <div class="user-info">
          <div class="user-avatar" id="userAvatar">A</div>
          <div>
            <div class="user-name" id="userName">Admin</div>
            <div class="user-email" id="userEmail">admin@example.com</div>
          </div>
        </div>
        <button class="btn btn-secondary btn-small" onclick="logout()" style="width: 100%;">Logout</button>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <div class="page-header">
        <h1>Settings</h1>
      </div>

      <!-- Tabs -->
      <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('general')">General</button>
        <button class="tab-btn" onclick="switchTab('users')">Users & Permissions</button>
        <button class="tab-btn" onclick="switchTab('activity')">Activity Logs</button>
        <button class="tab-btn" onclick="switchTab('notifications')">Notifications</button>
      </div>

      <!-- Tab: General -->
      <div class="tab-content active" id="tab-general">
        <div class="card">
          <div class="settings-form">
            <div class="form-group">
              <label>Timezone</label>
              <select id="settingTimezone">
                <option value="">Select timezone...</option>
                <option value="America/New_York">America/New_York (Eastern)</option>
                <option value="America/Chicago">America/Chicago (Central)</option>
                <option value="America/Denver">America/Denver (Mountain)</option>
                <option value="America/Los_Angeles">America/Los_Angeles (Pacific)</option>
                <option value="America/Anchorage">America/Anchorage (Alaska)</option>
                <option value="Pacific/Honolulu">Pacific/Honolulu (Hawaii)</option>
                <option value="UTC">UTC</option>
                <option value="Europe/London">Europe/London (GMT)</option>
                <option value="Europe/Paris">Europe/Paris (CET)</option>
                <option value="Asia/Tokyo">Asia/Tokyo (JST)</option>
                <option value="Asia/Shanghai">Asia/Shanghai (CST)</option>
                <option value="Australia/Sydney">Australia/Sydney (AEST)</option>
              </select>
            </div>

            <div class="form-group">
              <label>Site Name</label>
              <input type="text" id="settingSiteName" placeholder="Coastal Debt">
            </div>

            <div class="form-group">
              <label>Favicon URL</label>
              <div class="upload-row">
                <input type="text" id="settingFavicon" placeholder="/lp/uploads/favicon.ico">
                <input type="file" id="faviconFile" accept=".ico,.png,.jpg,.jpeg,.svg,.webp" style="display:none">
                <button class="upload-btn" onclick="document.getElementById('faviconFile').click()">Upload</button>
              </div>
              <div class="preview-box favicon" id="faviconPreview" style="display:none">
                <img id="faviconPreviewImg" src="" alt="Favicon preview">
              </div>
            </div>

            <div class="form-group">
              <label>Meta/OG Image URL</label>
              <div class="upload-row">
                <input type="text" id="settingMetaImage" placeholder="/lp/uploads/og-image.jpg">
                <input type="file" id="metaImageFile" accept=".png,.jpg,.jpeg,.svg,.webp" style="display:none">
                <button class="upload-btn" onclick="document.getElementById('metaImageFile').click()">Upload</button>
              </div>
              <div class="preview-box" id="metaImagePreview" style="display:none">
                <img id="metaImagePreviewImg" src="" alt="Meta image preview">
              </div>
            </div>

            <button class="btn btn-primary" style="width:auto" onclick="saveSettings()">Save Settings</button>
          </div>
        </div>
      </div>

      <!-- Tab: Users & Permissions -->
      <div class="tab-content" id="tab-users">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Users</h3>
            <button class="btn btn-primary btn-small" onclick="showModal('createUserModal')">+ Add User</button>
          </div>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Role</th>
                  <th>Created</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="usersTableBody">
                <tr><td colspan="5" class="loading"><div class="spinner"></div></td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Tab: Activity Logs -->
      <div class="tab-content" id="tab-activity">
        <div class="card">
          <div class="filters">
            <select id="activityUserFilter">
              <option value="">All Users</option>
            </select>
            <select id="activityEntityFilter">
              <option value="">All Types</option>
              <option value="user">User</option>
              <option value="page">Page</option>
              <option value="lead">Lead</option>
              <option value="postback_config">Postback Config</option>
              <option value="settings">Settings</option>
              <option value="google_ads">Google Ads</option>
              <option value="bing_ads">Bing Ads</option>
              <option value="facebook">Facebook</option>
            </select>
            <input type="date" id="activityFromDate">
            <input type="date" id="activityToDate">
            <button class="btn btn-primary btn-small" onclick="loadActivityLogs(1)">Filter</button>
            <button class="btn btn-secondary btn-small" onclick="exportActivityLogs()">Export CSV</button>
          </div>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>User</th>
                  <th>Action</th>
                  <th>Entity</th>
                  <th>Details</th>
                </tr>
              </thead>
              <tbody id="activityTableBody">
                <tr><td colspan="5" class="loading"><div class="spinner"></div></td></tr>
              </tbody>
            </table>
          </div>
          <div class="pagination" id="activityPagination"></div>
        </div>
      </div>
      <!-- Tab: Notifications -->
      <div class="tab-content" id="tab-notifications">
        <!-- SMTP Configuration -->
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">SMTP Configuration</h3>
          </div>
          <div class="settings-form">
            <div class="form-group">
              <label>SMTP Host</label>
              <input type="text" id="smtpHost" placeholder="smtp.gmail.com">
            </div>
            <div class="form-group">
              <label>SMTP Port</label>
              <input type="text" id="smtpPort" placeholder="587">
            </div>
            <div class="form-group">
              <label>SMTP User</label>
              <input type="text" id="smtpUser" placeholder="user@example.com">
            </div>
            <div class="form-group">
              <label>SMTP Password</label>
              <input type="password" id="smtpPass" placeholder="Password">
            </div>
            <div class="form-group">
              <label>From Address</label>
              <input type="text" id="smtpFrom" placeholder="noreply@example.com">
            </div>
            <div style="display:flex;gap:8px;">
              <button class="btn btn-primary" style="width:auto" onclick="saveSmtp()">Save SMTP</button>
              <button class="btn btn-secondary" style="width:auto" onclick="testSmtp()">Send Test Email</button>
            </div>
          </div>
        </div>

        <!-- Lead Notifications -->
        <div class="card" style="margin-top:20px;">
          <div class="card-header">
            <h3 class="card-title">Lead Notifications</h3>
          </div>
          <div class="settings-form">
            <div class="permission-item" style="max-width:600px;">
              <label for="leadNotifEnabled">Send email when new lead arrives</label>
              <label class="toggle"><input type="checkbox" id="leadNotifEnabled"><span class="toggle-slider"></span></label>
            </div>
            <div class="form-group" style="margin-top:16px;">
              <label>Email Recipients (comma-separated)</label>
              <input type="text" id="leadNotifRecipients" placeholder="admin@example.com, sales@example.com">
            </div>
            <button class="btn btn-primary" style="width:auto" onclick="saveLeadConfig()">Save Lead Notifications</button>
          </div>
        </div>

        <!-- Alert Rules -->
        <div class="card" style="margin-top:20px;">
          <div class="card-header">
            <h3 class="card-title">Alert Rules</h3>
            <button class="btn btn-primary btn-small" onclick="openAlertModal()">+ Add Rule</button>
          </div>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Condition</th>
                  <th>Status</th>
                  <th>Last Triggered</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="alertRulesTable">
                <tr><td colspan="5" class="loading"><div class="spinner"></div></td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Alert Rule Modal -->
  <div class="modal-overlay" id="alertRuleModal">
    <div class="modal">
      <div class="modal-header">
        <h2 id="alertModalTitle">Add Alert Rule</h2>
        <button class="modal-close" onclick="hideModal('alertRuleModal')">&times;</button>
      </div>
      <form id="alertRuleForm">
        <input type="hidden" id="alertRuleId">
        <div class="form-group">
          <label>Rule Name</label>
          <input type="text" id="alertRuleName" required placeholder="High spend no leads">
        </div>
        <div style="display:flex;gap:8px;">
          <div class="form-group" style="flex:1;">
            <label>Metric</label>
            <select id="alertMetric" required>
              <option value="spend">Spend ($)</option>
              <option value="leads">Leads</option>
              <option value="visitors">Visitors</option>
              <option value="clicks">Clicks</option>
            </select>
          </div>
          <div class="form-group" style="flex:1;">
            <label>Condition</label>
            <select id="alertCondition" required>
              <option value="greater_than">Greater than</option>
              <option value="less_than">Less than</option>
              <option value="equals">Equals</option>
            </select>
          </div>
          <div class="form-group" style="flex:1;">
            <label>Threshold</label>
            <input type="number" id="alertThreshold" required step="any" placeholder="100">
          </div>
        </div>
        <div class="form-group">
          <label>Time Window (hours)</label>
          <input type="number" id="alertTimeWindow" required value="24" min="1">
        </div>
        <h4 style="margin:16px 0 8px;color:var(--gray-600);">Secondary Condition (optional)</h4>
        <div style="display:flex;gap:8px;">
          <div class="form-group" style="flex:1;">
            <label>Metric</label>
            <select id="alertSecMetric">
              <option value="">None</option>
              <option value="leads">Leads</option>
              <option value="conversions">Conversions</option>
            </select>
          </div>
          <div class="form-group" style="flex:1;">
            <label>Condition</label>
            <select id="alertSecCondition">
              <option value="greater_than">Greater than</option>
              <option value="less_than">Less than</option>
              <option value="equals">Equals</option>
            </select>
          </div>
          <div class="form-group" style="flex:1;">
            <label>Threshold</label>
            <input type="number" id="alertSecThreshold" step="any" placeholder="0">
          </div>
        </div>
        <div class="form-group">
          <label>Email Recipients (comma-separated)</label>
          <input type="text" id="alertRecipients" placeholder="admin@example.com">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="hideModal('alertRuleModal')">Cancel</button>
          <button type="submit" class="btn btn-primary" style="width:auto">Save Rule</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Create User Modal -->
  <div class="modal-overlay" id="createUserModal">
    <div class="modal">
      <div class="modal-header">
        <h2>Add User</h2>
        <button class="modal-close" onclick="hideModal('createUserModal')">&times;</button>
      </div>
      <form id="createUserForm">
        <div class="form-group">
          <label>Name</label>
          <input type="text" id="createName" required placeholder="John Doe">
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="createEmail" required placeholder="john@example.com">
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="createPassword" required placeholder="Min 6 characters" minlength="6">
        </div>
        <div class="form-group">
          <label>Role</label>
          <select id="createRole">
            <option value="admin">Admin</option>
            <option value="editor" selected>Editor</option>
            <option value="viewer">Viewer</option>
          </select>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="hideModal('createUserModal')">Cancel</button>
          <button type="submit" class="btn btn-primary" style="width:auto">Create User</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit User Modal -->
  <div class="modal-overlay" id="editUserModal">
    <div class="modal">
      <div class="modal-header">
        <h2>Edit User</h2>
        <button class="modal-close" onclick="hideModal('editUserModal')">&times;</button>
      </div>
      <form id="editUserForm">
        <input type="hidden" id="editUserId">
        <div class="form-group">
          <label>Name</label>
          <input type="text" id="editName" required>
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="editEmail" required>
        </div>
        <div class="form-group">
          <label>New Password (leave blank to keep current)</label>
          <input type="password" id="editPassword" placeholder="Min 6 characters" minlength="6">
        </div>
        <div class="form-group">
          <label>Role</label>
          <select id="editRole">
            <option value="admin">Admin</option>
            <option value="editor">Editor</option>
            <option value="viewer">Viewer</option>
          </select>
        </div>
        <h4 style="margin: 20px 0 12px; color: var(--gray-700);">Permission Overrides</h4>
        <div class="permission-grid" id="editPermissions">
          <div class="permission-item"><label for="perm-pages">Can manage Landing Pages</label><label class="toggle"><input type="checkbox" id="perm-pages"><span class="toggle-slider"></span></label></div>
          <div class="permission-item"><label for="perm-leads">Can manage Leads</label><label class="toggle"><input type="checkbox" id="perm-leads"><span class="toggle-slider"></span></label></div>
          <div class="permission-item"><label for="perm-forms">Can manage Forms</label><label class="toggle"><input type="checkbox" id="perm-forms"><span class="toggle-slider"></span></label></div>
          <div class="permission-item"><label for="perm-scripts">Can manage Scripts</label><label class="toggle"><input type="checkbox" id="perm-scripts"><span class="toggle-slider"></span></label></div>
          <div class="permission-item"><label for="perm-integrations">Can manage Integrations</label><label class="toggle"><input type="checkbox" id="perm-integrations"><span class="toggle-slider"></span></label></div>
          <div class="permission-item"><label for="perm-users">Can manage Users</label><label class="toggle"><input type="checkbox" id="perm-users"><span class="toggle-slider"></span></label></div>
          <div class="permission-item"><label for="perm-settings">Can manage Settings</label><label class="toggle"><input type="checkbox" id="perm-settings"><span class="toggle-slider"></span></label></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="hideModal('editUserModal')">Cancel</button>
          <button type="submit" class="btn btn-primary" style="width:auto">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <script src="assets/js/common.js?v=2"></script>
  <script>
    let currentUserId = null;
    let allUsers = [];

    // ============ TABS ============
    function switchTab(tab) {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      document.getElementById('tab-' + tab).classList.add('active');
      document.querySelector(`[onclick="switchTab('${tab}')"]`).classList.add('active');

      if (tab === 'users') loadUsers();
      if (tab === 'activity') loadActivityLogs(1);
      if (tab === 'notifications') loadNotificationsTab();
    }

    // ============ GENERAL SETTINGS ============
    async function loadSettings() {
      try {
        const settings = await api('/api/settings');
        document.getElementById('settingTimezone').value = settings.timezone || '';
        document.getElementById('settingSiteName').value = settings.site_name || '';
        document.getElementById('settingFavicon').value = settings.favicon_url || '';
        document.getElementById('settingMetaImage').value = settings.meta_image_url || '';
        updatePreviews();
      } catch (err) {
        console.error('Failed to load settings:', err);
      }
    }

    async function saveSettings() {
      try {
        await api('/api/settings', {
          method: 'POST',
          body: JSON.stringify({
            timezone: document.getElementById('settingTimezone').value,
            site_name: document.getElementById('settingSiteName').value,
            favicon_url: document.getElementById('settingFavicon').value,
            meta_image_url: document.getElementById('settingMetaImage').value
          })
        });
        alert('Settings saved successfully!');
      } catch (err) {
        alert('Failed to save: ' + err.message);
      }
    }

    function updatePreviews() {
      const favicon = document.getElementById('settingFavicon').value;
      const metaImg = document.getElementById('settingMetaImage').value;

      if (favicon) {
        document.getElementById('faviconPreviewImg').src = favicon;
        document.getElementById('faviconPreview').style.display = 'block';
      } else {
        document.getElementById('faviconPreview').style.display = 'none';
      }

      if (metaImg) {
        document.getElementById('metaImagePreviewImg').src = metaImg;
        document.getElementById('metaImagePreview').style.display = 'block';
      } else {
        document.getElementById('metaImagePreview').style.display = 'none';
      }
    }

    document.getElementById('settingFavicon').addEventListener('input', updatePreviews);
    document.getElementById('settingMetaImage').addEventListener('input', updatePreviews);

    // File upload handlers
    async function uploadFile(fileInput, targetInput) {
      const file = fileInput.files[0];
      if (!file) return;

      const formData = new FormData();
      formData.append('file', file);

      try {
        const res = await fetch('/api/settings/upload', { method: 'POST', body: formData });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error);
        targetInput.value = data.url;
        updatePreviews();
      } catch (err) {
        alert('Upload failed: ' + err.message);
      }
    }

    document.getElementById('faviconFile').addEventListener('change', function() {
      uploadFile(this, document.getElementById('settingFavicon'));
    });
    document.getElementById('metaImageFile').addEventListener('change', function() {
      uploadFile(this, document.getElementById('settingMetaImage'));
    });

    // ============ USERS & PERMISSIONS ============
    async function loadUsers() {
      try {
        const meRes = await fetch('/api/auth/me');
        const me = await meRes.json();
        currentUserId = me.id;

        const users = await api('/api/auth/users');
        allUsers = users;

        // Populate activity log user filter
        const userFilter = document.getElementById('activityUserFilter');
        const currentFilterVal = userFilter.value;
        userFilter.innerHTML = '<option value="">All Users</option>';
        users.forEach(u => {
          userFilter.innerHTML += `<option value="${u.id}">${u.name}</option>`;
        });
        userFilter.value = currentFilterVal;

        const tbody = document.getElementById('usersTableBody');
        if (users.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" class="empty-state">No users found</td></tr>';
        } else {
          tbody.innerHTML = users.map(user => `
            <tr>
              <td>
                <div style="display:flex;align-items:center;gap:12px;">
                  <div class="user-avatar" style="width:36px;height:36px;font-size:14px;">${user.name.charAt(0).toUpperCase()}</div>
                  <strong>${user.name}</strong>
                </div>
              </td>
              <td>${user.email}</td>
              <td><span class="badge ${user.role === 'admin' ? 'badge-blue' : user.role === 'editor' ? 'badge-green' : 'badge-gray'}">${user.role}</span></td>
              <td>${formatDate(user.created_at)}</td>
              <td class="actions">
                <button class="action-btn action-btn-edit" onclick="editUser(${user.id})">Edit</button>
                ${user.id !== currentUserId ? `<button class="action-btn action-btn-delete" onclick="deleteUser(${user.id})">Delete</button>` : ''}
              </td>
            </tr>
          `).join('');
        }
      } catch (err) {
        console.error('Failed to load users:', err);
      }
    }

    document.getElementById('createUserForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      try {
        await api('/api/auth/users', {
          method: 'POST',
          body: JSON.stringify({
            name: document.getElementById('createName').value,
            email: document.getElementById('createEmail').value,
            password: document.getElementById('createPassword').value,
            role: document.getElementById('createRole').value
          })
        });
        hideModal('createUserModal');
        document.getElementById('createUserForm').reset();
        loadUsers();
      } catch (err) {
        alert(err.message);
      }
    });

    async function editUser(id) {
      try {
        const users = allUsers.length ? allUsers : await api('/api/auth/users');
        const user = users.find(u => u.id === id);
        if (!user) return;

        document.getElementById('editUserId').value = user.id;
        document.getElementById('editName').value = user.name;
        document.getElementById('editEmail').value = user.email;
        document.getElementById('editPassword').value = '';
        document.getElementById('editRole').value = user.role;

        // Load permissions
        const permsData = await api(`/api/settings/permissions/${id}`);
        const perms = permsData.permissions;
        document.getElementById('perm-pages').checked = perms.pages || false;
        document.getElementById('perm-leads').checked = perms.leads || false;
        document.getElementById('perm-forms').checked = perms.forms || false;
        document.getElementById('perm-scripts').checked = perms.scripts || false;
        document.getElementById('perm-integrations').checked = perms.integrations || false;
        document.getElementById('perm-users').checked = perms.users || false;
        document.getElementById('perm-settings').checked = perms.settings || false;

        showModal('editUserModal');
      } catch (err) {
        alert(err.message);
      }
    }

    document.getElementById('editUserForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = document.getElementById('editUserId').value;
      const data = {
        name: document.getElementById('editName').value,
        email: document.getElementById('editEmail').value,
        role: document.getElementById('editRole').value
      };
      const password = document.getElementById('editPassword').value;
      if (password) data.password = password;

      try {
        await api(`/api/auth/users/${id}`, { method: 'PUT', body: JSON.stringify(data) });

        // Save permissions
        const permissions = {
          pages: document.getElementById('perm-pages').checked,
          leads: document.getElementById('perm-leads').checked,
          forms: document.getElementById('perm-forms').checked,
          scripts: document.getElementById('perm-scripts').checked,
          integrations: document.getElementById('perm-integrations').checked,
          users: document.getElementById('perm-users').checked,
          settings: document.getElementById('perm-settings').checked
        };
        await api(`/api/settings/permissions/${id}`, {
          method: 'PUT',
          body: JSON.stringify({ permissions })
        });

        hideModal('editUserModal');
        loadUsers();
      } catch (err) {
        alert(err.message);
      }
    });

    // Update permission toggles when role changes
    document.getElementById('editRole').addEventListener('change', async function() {
      try {
        const defaults = await api('/api/settings/permissions-defaults');
        const rolePerms = defaults[this.value] || {};
        document.getElementById('perm-pages').checked = rolePerms.pages || false;
        document.getElementById('perm-leads').checked = rolePerms.leads || false;
        document.getElementById('perm-forms').checked = rolePerms.forms || false;
        document.getElementById('perm-scripts').checked = rolePerms.scripts || false;
        document.getElementById('perm-integrations').checked = rolePerms.integrations || false;
        document.getElementById('perm-users').checked = rolePerms.users || false;
        document.getElementById('perm-settings').checked = rolePerms.settings || false;
      } catch (err) {
        console.error('Failed to load defaults:', err);
      }
    });

    async function deleteUser(id) {
      if (id === currentUserId) { alert('Cannot delete yourself'); return; }
      if (!confirm('Are you sure you want to delete this user?')) return;
      try {
        await api(`/api/auth/users/${id}`, { method: 'DELETE' });
        loadUsers();
      } catch (err) {
        alert(err.message);
      }
    }

    // ============ ACTIVITY LOGS ============
    let activityPage = 1;

    async function loadActivityLogs(page) {
      activityPage = page || 1;
      const params = new URLSearchParams({ page: activityPage, limit: 50 });

      const userId = document.getElementById('activityUserFilter').value;
      const entityType = document.getElementById('activityEntityFilter').value;
      const fromDate = document.getElementById('activityFromDate').value;
      const toDate = document.getElementById('activityToDate').value;

      if (userId) params.set('user_id', userId);
      if (entityType) params.set('entity_type', entityType);
      if (fromDate) params.set('from_date', fromDate);
      if (toDate) params.set('to_date', toDate + 'T23:59:59');

      try {
        const data = await api(`/api/settings/activity?${params}`);
        const tbody = document.getElementById('activityTableBody');

        if (data.logs.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" class="empty-state">No activity logs found</td></tr>';
        } else {
          tbody.innerHTML = data.logs.map(log => `
            <tr>
              <td>${formatDate(log.created_at)}</td>
              <td>${log.user_name || 'System'}</td>
              <td><span class="badge ${actionBadge(log.action)}">${log.action}</span></td>
              <td>${log.entity_type || '-'}</td>
              <td>${log.details || '-'}</td>
            </tr>
          `).join('');
        }

        // Render pagination
        const pag = data.pagination;
        const pagDiv = document.getElementById('activityPagination');
        if (pag.pages <= 1) {
          pagDiv.innerHTML = '';
        } else {
          let html = `<button ${pag.page <= 1 ? 'disabled' : ''} onclick="loadActivityLogs(${pag.page - 1})">Prev</button>`;
          html += `<span>Page ${pag.page} of ${pag.pages} (${pag.total} total)</span>`;
          html += `<button ${pag.page >= pag.pages ? 'disabled' : ''} onclick="loadActivityLogs(${pag.page + 1})">Next</button>`;
          pagDiv.innerHTML = html;
        }
      } catch (err) {
        console.error('Failed to load activity logs:', err);
      }
    }

    function actionBadge(action) {
      const map = { created: 'badge-green', updated: 'badge-blue', deleted: 'badge-red', login: 'badge-gray', connected: 'badge-green', disconnected: 'badge-yellow' };
      return map[action] || 'badge-gray';
    }

    function exportActivityLogs() {
      const params = new URLSearchParams();
      const userId = document.getElementById('activityUserFilter').value;
      const entityType = document.getElementById('activityEntityFilter').value;
      const fromDate = document.getElementById('activityFromDate').value;
      const toDate = document.getElementById('activityToDate').value;

      if (userId) params.set('user_id', userId);
      if (entityType) params.set('entity_type', entityType);
      if (fromDate) params.set('from_date', fromDate);
      if (toDate) params.set('to_date', toDate + 'T23:59:59');

      window.location.href = `/api/settings/activity/export?${params}`;
    }

    // ============ NOTIFICATIONS ============
    function loadNotificationsTab() {
      loadSmtpConfig();
      loadLeadConfig();
      loadAlertRules();
    }

    async function loadSmtpConfig() {
      try {
        const data = await api('/api/notifications/smtp');
        document.getElementById('smtpHost').value = data.smtp_host || '';
        document.getElementById('smtpPort').value = data.smtp_port || '587';
        document.getElementById('smtpUser').value = data.smtp_user || '';
        document.getElementById('smtpPass').value = '';
        document.getElementById('smtpPass').placeholder = data.smtp_pass ? '********' : 'Password';
        document.getElementById('smtpFrom').value = data.smtp_from || '';
      } catch (err) { console.error('Failed to load SMTP config:', err); }
    }

    async function saveSmtp() {
      try {
        const passVal = document.getElementById('smtpPass').value;
        const body = {
          smtp_host: document.getElementById('smtpHost').value,
          smtp_port: document.getElementById('smtpPort').value,
          smtp_user: document.getElementById('smtpUser').value,
          smtp_from: document.getElementById('smtpFrom').value
        };
        if (passVal) body.smtp_pass = passVal;
        await api('/api/notifications/smtp', { method: 'POST', body: JSON.stringify(body) });
        alert('SMTP settings saved!');
        loadSmtpConfig();
      } catch (err) { alert('Failed to save: ' + err.message); }
    }

    async function testSmtp() {
      const to = prompt('Send test email to:');
      if (!to) return;
      try {
        await api('/api/notifications/smtp/test', { method: 'POST', body: JSON.stringify({ to }) });
        alert('Test email sent!');
      } catch (err) { alert('Failed: ' + err.message); }
    }

    async function loadLeadConfig() {
      try {
        const data = await api('/api/notifications/lead-config');
        document.getElementById('leadNotifEnabled').checked = !!data.enabled;
        document.getElementById('leadNotifRecipients').value = data.email_recipients || '';
      } catch (err) { console.error('Failed to load lead config:', err); }
    }

    async function saveLeadConfig() {
      try {
        await api('/api/notifications/lead-config', {
          method: 'POST',
          body: JSON.stringify({
            enabled: document.getElementById('leadNotifEnabled').checked,
            email_recipients: document.getElementById('leadNotifRecipients').value
          })
        });
        alert('Lead notification settings saved!');
      } catch (err) { alert('Failed to save: ' + err.message); }
    }

    async function loadAlertRules() {
      try {
        const rules = await api('/api/notifications/alert-rules');
        const tbody = document.getElementById('alertRulesTable');
        if (rules.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" class="empty-state">No alert rules configured</td></tr>';
          return;
        }
        const condLabel = (c) => ({ greater_than: '>', less_than: '<', equals: '=' }[c] || c);
        tbody.innerHTML = rules.map(r => `
          <tr>
            <td><strong>${r.name}</strong></td>
            <td>${r.metric} ${condLabel(r.condition)} ${r.threshold}${r.secondary_metric ? ` AND ${r.secondary_metric} ${condLabel(r.secondary_condition)} ${r.secondary_threshold}` : ''} (${r.time_window_hours}h)</td>
            <td><span class="badge ${r.enabled ? 'badge-green' : 'badge-gray'}">${r.enabled ? 'Enabled' : 'Disabled'}</span></td>
            <td>${r.last_triggered_at ? formatDate(r.last_triggered_at) : 'Never'}</td>
            <td class="actions">
              <button class="action-btn action-btn-edit" onclick="editAlertRule(${r.id})">Edit</button>
              <button class="action-btn action-btn-delete" onclick="deleteAlertRule(${r.id})">Delete</button>
            </td>
          </tr>
        `).join('');
      } catch (err) { console.error('Failed to load alert rules:', err); }
    }

    let alertRulesCache = [];

    function openAlertModal(rule) {
      document.getElementById('alertModalTitle').textContent = rule ? 'Edit Alert Rule' : 'Add Alert Rule';
      document.getElementById('alertRuleId').value = rule ? rule.id : '';
      document.getElementById('alertRuleName').value = rule ? rule.name : '';
      document.getElementById('alertMetric').value = rule ? rule.metric : 'spend';
      document.getElementById('alertCondition').value = rule ? rule.condition : 'greater_than';
      document.getElementById('alertThreshold').value = rule ? rule.threshold : '';
      document.getElementById('alertTimeWindow').value = rule ? rule.time_window_hours : 24;
      document.getElementById('alertSecMetric').value = rule ? (rule.secondary_metric || '') : '';
      document.getElementById('alertSecCondition').value = rule ? (rule.secondary_condition || 'greater_than') : 'greater_than';
      document.getElementById('alertSecThreshold').value = rule && rule.secondary_threshold !== null ? rule.secondary_threshold : '';
      document.getElementById('alertRecipients').value = rule ? (rule.email_recipients || '') : '';
      showModal('alertRuleModal');
    }

    async function editAlertRule(id) {
      try {
        const rules = await api('/api/notifications/alert-rules');
        const rule = rules.find(r => r.id === id);
        if (rule) openAlertModal(rule);
      } catch (err) { alert(err.message); }
    }

    async function deleteAlertRule(id) {
      if (!confirm('Delete this alert rule?')) return;
      try {
        await api(`/api/notifications/alert-rules/${id}`, { method: 'DELETE' });
        loadAlertRules();
      } catch (err) { alert(err.message); }
    }

    document.getElementById('alertRuleForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = document.getElementById('alertRuleId').value;
      const body = {
        name: document.getElementById('alertRuleName').value,
        enabled: true,
        metric: document.getElementById('alertMetric').value,
        condition: document.getElementById('alertCondition').value,
        threshold: parseFloat(document.getElementById('alertThreshold').value),
        time_window_hours: parseInt(document.getElementById('alertTimeWindow').value),
        secondary_metric: document.getElementById('alertSecMetric').value || null,
        secondary_condition: document.getElementById('alertSecMetric').value ? document.getElementById('alertSecCondition').value : null,
        secondary_threshold: document.getElementById('alertSecMetric').value ? parseFloat(document.getElementById('alertSecThreshold').value) || 0 : null,
        email_recipients: document.getElementById('alertRecipients').value
      };

      try {
        if (id) {
          await api(`/api/notifications/alert-rules/${id}`, { method: 'PUT', body: JSON.stringify(body) });
        } else {
          await api('/api/notifications/alert-rules', { method: 'POST', body: JSON.stringify(body) });
        }
        hideModal('alertRuleModal');
        loadAlertRules();
      } catch (err) { alert(err.message); }
    });

    // ============ INIT ============
    loadSettings();
  </script>
</body>
</html>
