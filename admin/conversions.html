<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Conversions | Coastal Debt CMS</title>
  <link rel="stylesheet" href="assets/css/style.css?v=4">
  <style>
    .postback-url {
      background: #f1f5f9;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-family: monospace;
      word-break: break-all;
    }
    .postback-url code {
      background: #1e293b;
      color: #22d3ee;
      padding: 8px 12px;
      border-radius: 4px;
      display: block;
      margin-top: 8px;
    }
    .copy-btn {
      background: #3052FF;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      margin-top: 8px;
    }
    .status-sent { color: #16a34a; }
    .status-failed { color: #dc2626; }
    .status-pending { color: #f59e0b; }
    .status-logged { color: #6b7280; }
    .tabs {
      display: flex;
      gap: 0;
      margin-bottom: 20px;
      border-bottom: 2px solid #e5e7eb;
    }
    .tab {
      padding: 12px 24px;
      border: none;
      background: none;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      color: #6b7280;
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
    }
    .tab.active {
      color: #3052FF;
      border-bottom-color: #3052FF;
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .event-config {
      background: #f9fafb;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .event-config .name { font-weight: 600; }
    .event-config .event-name {
      font-family: monospace;
      background: #e5e7eb;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 13px;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-logo">
        <img src="https://cdn.prod.website-files.com/6634aeab2fd552b666b69c25/68d3ea2a40971102ff6b605f_4df5ec858fd5062f2c7c25ddc701c00e_Coastal%20Debt%20Resolve_id2iMYK6Ad_1%201%20(1).svg" alt="Coastal Debt" style="height:36px;background:#fff;padding:8px 12px;border-radius:8px;">
      </div>
      <nav class="sidebar-nav">
        <a href="/admin/">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
          Dashboard
        </a>
        <a href="/admin/leads.html">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg>
          Leads
        </a>
        <a href="/admin/visitors.html">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
          Visitors
        </a>
        <a href="/admin/conversions.html" class="active">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
          Conversions
        </a>
        <a href="/admin/google-ads.html">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>
          Google Ads
        </a>
        <a href="/admin/bing-ads.html">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 3v18l5-3 9 4V4L10 0z"/></svg>
          Bing Ads
        </a>
        <a href="/admin/meta-ads.html">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 2h-3a5 5 0 00-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 011-1h3z"/></svg>
          Meta Ads
        </a>
        <a href="/admin/facebook-debug.html">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 013 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
          FB Debug
        </a>
        <a href="/admin/utm-builder.html">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"/></svg>
          UTM Builder
        </a>
        <a href="/admin/organic.html">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M2 12h20"/><path d="M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10 15.3 15.3 0 014-10z"/></svg>
          Organic Traffic
        </a>
        <a href="/admin/pages.html">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
          Landing Pages
        </a>
        <a href="/admin/forms.html">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M9 9h6M9 13h6M9 17h4"/></svg>
          Forms
        </a>
        <a href="/admin/scripts.html">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>
          Scripts
        </a>
        <a href="/admin/settings.html">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
          Integrations
        </a>
        <a href="/admin/platform-settings.html">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12.22 2h-.44a2 2 0 00-2 2v.18a2 2 0 01-1 1.73l-.43.25a2 2 0 01-2 0l-.15-.08a2 2 0 00-2.73.73l-.22.38a2 2 0 00.73 2.73l.15.1a2 2 0 011 1.72v.51a2 2 0 01-1 1.74l-.15.09a2 2 0 00-.73 2.73l.22.38a2 2 0 002.73.73l.15-.08a2 2 0 012 0l.43.25a2 2 0 011 1.73V20a2 2 0 002 2h.44a2 2 0 002-2v-.18a2 2 0 011-1.73l.43-.25a2 2 0 012 0l.15.08a2 2 0 002.73-.73l.22-.39a2 2 0 00-.73-2.73l-.15-.08a2 2 0 01-1-1.74v-.5a2 2 0 011-1.74l.15-.09a2 2 0 00.73-2.73l-.22-.38a2 2 0 00-2.73-.73l-.15.08a2 2 0 01-2 0l-.43-.25a2 2 0 01-1-1.73V4a2 2 0 00-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
          Settings
        </a>
      </nav>
      <div class="sidebar-footer">
        <div class="user-info">
          <div class="user-avatar" id="userAvatar">A</div>
          <div>
            <div class="user-name" id="userName">Admin</div>
            <div class="user-email" id="userEmail">admin@example.com</div>
          </div>
        </div>
        <button class="btn btn-secondary btn-small" onclick="logout()" style="width: 100%;">Logout</button>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <div class="page-header">
        <h1>Conversions & Postbacks</h1>
      </div>

      <!-- Postback URL Section -->
      <div class="card" style="margin-bottom: 20px;">
        <h3>Postback URL for Salesforce</h3>
        <p style="color: #6b7280; margin-bottom: 16px;">Use this URL in Salesforce to send conversion events back to your CMS.</p>

        <div class="postback-url">
          <strong>Postback URL:</strong>
          <code id="postbackUrl">Loading...</code>
          <button class="copy-btn" onclick="copyUrl()">Copy URL</button>
        </div>

        <div style="background: #f0fdf4; padding: 16px; border-radius: 8px; border: 1px solid #86efac;">
          <strong>Salesforce Setup:</strong>
          <ol style="margin: 12px 0 0 20px; color: #166534;">
            <li>In Salesforce, create a workflow rule or Process Builder flow</li>
            <li>When a lead status changes, make an HTTP POST to the postback URL</li>
            <li>Include: <code>eli_clickid={Lead.Eli_Click_ID__c}&event={status}&debt_amount={debt}&revenue={revenue}&value={amount}</code></li>
          </ol>
        </div>

        <div style="background: #eff6ff; padding: 16px; border-radius: 8px; border: 1px solid #93c5fd; margin-top: 16px;">
          <strong>Accepted Salesforce Fields:</strong>
          <p style="color: #1e40af; margin: 8px 0 12px 0; font-size: 14px;">
            These fields can be sent with each postback to update lead tracking data:
          </p>
          <div id="sfFieldsList" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
            <div style="background: white; padding: 10px 14px; border-radius: 6px; font-size: 13px;">
              <code style="background:#dbeafe; padding:2px 6px; border-radius:4px; color:#1e40af;">transfer_status</code>
              <span style="color:#6b7280; margin-left:6px;">Lead transfer status</span>
            </div>
            <div style="background: white; padding: 10px 14px; border-radius: 6px; font-size: 13px;">
              <code style="background:#dbeafe; padding:2px 6px; border-radius:4px; color:#1e40af;">five9_dispo</code>
              <span style="color:#6b7280; margin-left:6px;">Five9 disposition</span>
            </div>
            <div style="background: white; padding: 10px 14px; border-radius: 6px; font-size: 13px;">
              <code style="background:#dbeafe; padding:2px 6px; border-radius:4px; color:#1e40af;">stage</code>
              <span style="color:#6b7280; margin-left:6px;">Pipeline stage</span>
            </div>
            <div style="background: white; padding: 10px 14px; border-radius: 6px; font-size: 13px;">
              <code style="background:#dbeafe; padding:2px 6px; border-radius:4px; color:#1e40af;">contract_sign_date</code>
              <span style="color:#6b7280; margin-left:6px;">Contract signing date</span>
            </div>
            <div style="background: white; padding: 10px 14px; border-radius: 6px; font-size: 13px;">
              <code style="background:#dbeafe; padding:2px 6px; border-radius:4px; color:#1e40af;">total_debt_sign</code>
              <span style="color:#6b7280; margin-left:6px;">Total debt at signing</span>
            </div>
          </div>
          <p style="color: #1e40af; margin: 12px 0 0 0; font-size: 13px;">
            Example: <code style="background:#1e293b; color:#22d3ee; padding:4px 8px; border-radius:4px; font-size:12px;">...&transfer_status=Transferred&five9_dispo=Sale&stage=Closed Won&contract_sign_date=2025-01-15&total_debt_sign=50000</code>
          </p>
        </div>
      </div>

      <!-- Tabs -->
      <div class="tabs">
        <button class="tab active" onclick="showTab('events')">Conversion Events</button>
        <button class="tab" onclick="showTab('config')">Event Configuration</button>
      </div>

      <!-- Events Tab -->
      <div id="tab-events" class="tab-content active">
        <div class="card">
          <div class="filters" style="margin-bottom: 12px;">
            <div class="time-range-btns">
              <button data-range="today" onclick="setRange('today', this)">Today</button>
              <button data-range="yesterday" onclick="setRange('yesterday', this)">Yesterday</button>
              <button data-range="last_week" onclick="setRange('last_week', this)">Last Week</button>
              <button data-range="mtd" onclick="setRange('mtd', this)">MTD</button>
              <button data-range="7d" onclick="setRange('7d', this)">Last 7 Days</button>
              <button data-range="30d" onclick="setRange('30d', this)">Last 30 Days</button>
              <button class="active" data-range="all" onclick="setRange('all', this)">All Time</button>
              <button data-range="custom" onclick="setRange('custom', this)">Custom</button>
            </div>
            <input type="date" id="fromDate" class="tr-from" style="display:none;">
            <input type="date" id="toDate" class="tr-to" style="display:none;">
            <button class="btn btn-primary" onclick="loadEvents(1)">Apply</button>
          </div>
          <div id="columnEditorMount" style="margin-bottom:12px;text-align:right;"></div>
          <div class="table-container">
            <table>
              <thead>
                <tr id="tableHead"></tr>
              </thead>
              <tbody id="eventsTable">
                <tr><td colspan="99" class="loading"><div class="spinner"></div></td></tr>
              </tbody>
            </table>
          </div>
          <div id="eventsPagination" style="margin-top: 20px; display: flex; gap: 8px; justify-content: center;"></div>
        </div>
      </div>

      <!-- Config Tab -->
      <div id="tab-config" class="tab-content">
        <div class="card">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="margin: 0;">Event Configuration</h3>
            <button class="btn btn-primary" onclick="editingConfigId=null;document.querySelector('#addConfigModal h2').textContent='Add Event Mapping';document.getElementById('addConfigForm').reset();showModal('addConfigModal')">+ Add Event</button>
          </div>

          <p style="color: #6b7280; margin-bottom: 20px;">
            Map Salesforce events to Google Ads conversion actions. When a postback with a matching event name is received, it will be sent to Google Ads.
          </p>

          <div id="configList">
            <p class="empty-state">Loading...</p>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Add Config Modal -->
  <div class="modal-overlay" id="addConfigModal">
    <div class="modal">
      <div class="modal-header">
        <h2>Add Event Mapping</h2>
        <button class="modal-close" onclick="hideModal('addConfigModal')">&times;</button>
      </div>
      <form id="addConfigForm">
        <div class="form-group">
          <label>Display Name</label>
          <input type="text" id="configName" required placeholder="e.g., Lead Qualified">
        </div>
        <div class="form-group">
          <label>Event Name (from Salesforce/CRM)</label>
          <input type="text" id="configEventName" required placeholder="e.g., qualified">
          <small style="color: #666;">This must match the event name sent in the postback URL</small>
        </div>
        <div class="form-group">
          <label>Google Ads Conversion Action Name</label>
          <input type="text" id="configGoogleAdsEventName" placeholder="e.g., Lead, Purchase, Signup">
          <small style="color: #666;">The exact conversion action name Google Ads expects to receive</small>
        </div>
        <div class="form-group">
          <label>Google Ads Conversion Action ID (optional)</label>
          <input type="text" id="configConversionAction" placeholder="e.g., customers/123/conversionActions/456">
          <small style="color: #666;">The conversion action resource name from Google Ads API</small>
        </div>
        <div class="form-group">
          <label>Facebook CAPI Event</label>
          <select id="configFacebookEventName">
            <option value="">-- Don't send to Facebook --</option>
            <option value="Lead">Lead</option>
            <option value="CompleteRegistration">CompleteRegistration</option>
            <option value="Purchase">Purchase</option>
            <option value="Schedule">Schedule</option>
            <option value="Contact">Contact</option>
            <option value="SubmitApplication">SubmitApplication</option>
            <option value="AddPaymentInfo">AddPaymentInfo</option>
            <option value="Subscribe">Subscribe</option>
            <option value="StartTrial">StartTrial</option>
            <option value="InitiateCheckout">InitiateCheckout</option>
            <option value="ViewContent">ViewContent</option>
            <option value="Search">Search</option>
            <option value="AddToCart">AddToCart</option>
          </select>
          <small style="color: #666;">Select the Facebook standard event to send via Conversions API</small>
        </div>
        <div class="form-group">
          <label>Bing Ads Conversion Goal Name</label>
          <input type="text" id="configBingConversionGoalId" placeholder="e.g., Lead, Purchase">
          <small style="color: #666;">The conversion goal name in Microsoft Advertising</small>
        </div>
        <div class="form-group">
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
            <input type="checkbox" id="configSendToBing" style="width:auto;">
            Send to Bing Ads
          </label>
          <small style="color: #666;">When enabled, this event will also be sent to Microsoft Advertising via msclkid</small>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="hideModal('addConfigModal')">Cancel</button>
          <button type="submit" class="btn btn-primary">Save</button>
        </div>
      </form>
    </div>
  </div>

  <script src="assets/js/common.js?v=4"></script>
  <script>
    const COLUMNS = [
      { key: 'full_name', label: 'Lead', default: true },
      { key: 'conversion_action_name', label: 'Event', default: true },
      { key: 'conversion_value', label: 'Value', default: true },
      { key: 'debt_amount', label: 'Debt Amount', default: true },
      { key: 'revenue', label: 'Revenue', default: true },
      { key: 'gclid', label: 'GCLID', default: false },
      { key: 'eli_clickid', label: 'Eli Click ID', default: false },
      { key: 'source', label: 'Source', default: true },
      { key: 'status', label: 'Status', default: true },
      { key: 'created_at', label: 'Date', default: true },
      { key: 'actions', label: 'Actions', locked: true }
    ];

    const cellRenderers = {
      full_name: (e) => '<td>' + escapeHtml(e.full_name || e.email || '-') + '</td>',
      conversion_action_name: (e) => '<td><strong>' + escapeHtml(e.conversion_action_name || '-') + '</strong></td>',
      conversion_value: (e) => '<td>' + (e.conversion_value ? '$' + Number(e.conversion_value).toLocaleString() : '-') + '</td>',
      debt_amount: (e) => '<td>' + (e.debt_amount ? '$' + Number(e.debt_amount).toLocaleString() : '-') + '</td>',
      revenue: (e) => '<td>' + (e.revenue ? '$' + Number(e.revenue).toLocaleString() : '-') + '</td>',
      gclid: (e) => '<td style="font-size: 11px;">' + escapeHtml(e.gclid || '-') + '</td>',
      eli_clickid: (e) => '<td style="font-size: 11px;">' + escapeHtml(e.eli_clickid || '-') + '</td>',
      source: (e) => '<td>' + escapeHtml(e.source || '-') + '</td>',
      status: (e) => '<td><span class="status-' + escapeHtml(e.status || '') + '">' + escapeHtml(e.status || '-') + '</span></td>',
      created_at: (e) => '<td>' + formatDate(e.created_at) + '</td>',
      actions: (e) => '<td>' + (e.status === 'failed' ? '<button class="action-btn action-btn-edit" onclick="retryEvent(' + e.id + ')">Retry</button>' : '') + '</td>'
    };

    function renderTable() {
      document.getElementById('tableHead').innerHTML = columnEditor.renderHeader();
    }

    const columnEditor = new ColumnEditor({
      pageId: 'conversions',
      columns: COLUMNS,
      mountTo: '#columnEditorMount',
      onColumnsChange: () => { renderTable(); loadEvents(currentEventsPage); }
    });
    renderTable();

    let currentEventsPage = 1;
    let currentRange = 'all';

    function setRange(range, btn) {
      currentRange = range;
      document.querySelectorAll('.time-range-btns button').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      const show = range === 'custom';
      document.getElementById('fromDate').style.display = show ? '' : 'none';
      document.getElementById('toDate').style.display = show ? '' : 'none';
      if (range !== 'custom') loadEvents(1);
    }

    function showTab(tabName) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));

      document.querySelector(`.tab[onclick="showTab('${tabName}')"]`).classList.add('active');
      document.getElementById('tab-' + tabName).classList.add('active');
    }

    async function loadPostbackUrl() {
      const res = await fetch('/api/postback/url');
      const data = await res.json();
      document.getElementById('postbackUrl').textContent = data.postback_url;
    }

    function copyUrl() {
      const url = document.getElementById('postbackUrl').textContent;
      navigator.clipboard.writeText(url);
      alert('URL copied!');
    }

    async function loadEvents(page = 1) {
      currentEventsPage = page;
      const dateRange = currentRange === 'custom'
        ? { from: document.getElementById('fromDate').value, to: document.getElementById('toDate').value }
        : getDateRangeFromPreset(currentRange);
      const params = new URLSearchParams({ page, limit: 25 });
      if (dateRange.from) params.append('from_date', dateRange.from);
      if (dateRange.to) params.append('to_date', dateRange.to);
      const res = await fetch(`/api/postback/events?${params}`);
      const data = await res.json();

      const tbody = document.getElementById('eventsTable');
      const cols = columnEditor.getVisibleColumns();
      if (data.events.length === 0) {
        tbody.innerHTML = '<tr><td colspan="99" class="empty-state">No conversion events yet</td></tr>';
      } else {
        tbody.innerHTML = data.events.map(e =>
          '<tr>' + cols.map(key => cellRenderers[key](e)).join('') + '</tr>'
        ).join('');
      }

      // Pagination
      const pagination = document.getElementById('eventsPagination');
      pagination.innerHTML = '';
      for (let i = 1; i <= data.pagination.pages; i++) {
        const btn = document.createElement('button');
        btn.className = `btn btn-small ${i === currentEventsPage ? 'btn-primary' : 'btn-secondary'}`;
        btn.textContent = i;
        btn.onclick = () => loadEvents(i);
        pagination.appendChild(btn);
      }
    }

    async function retryEvent(id) {
      const res = await fetch(`/api/postback/events/${id}/retry`, { method: 'POST' });
      const data = await res.json();

      if (res.ok) {
        alert('Conversion sent to Google Ads!');
        loadEvents(currentEventsPage);
      } else {
        alert('Error: ' + data.error);
      }
    }

    async function loadConfigs() {
      const res = await fetch('/api/postback/config');
      const configs = await res.json();

      const container = document.getElementById('configList');
      if (configs.length === 0) {
        container.innerHTML = '<p class="empty-state">No event mappings configured. Add one to start sending conversions to Google Ads.</p>';
      } else {
        container.innerHTML = configs.map(c => `
          <div class="event-config">
            <div>
              <div class="name">${c.name}</div>
              <div style="margin-top: 4px;">
                CRM Event: <span class="event-name">${c.event_name}</span>
                ${c.google_ads_event_name ? ` â†’ Google Ads: <span class="event-name" style="background:#dcfce7;color:#166534;">${c.google_ads_event_name}</span>` : ''}
                ${c.conversion_action_id ? ` (ID: <span style="font-size:12px;color:#666;">${c.conversion_action_id}</span>)` : ''}
                ${c.facebook_event_name ? ` | Facebook: <span class="event-name" style="background:#dbeafe;color:#1d4ed8;">${c.facebook_event_name}</span>` : ''}
                ${c.send_to_bing && c.bing_conversion_goal_id ? ` | Bing: <span class="event-name" style="background:#fff3cd;color:#856404;">${c.bing_conversion_goal_id}</span>` : ''}
                ${!c.google_ads_event_name && !c.conversion_action_id && !c.facebook_event_name && !c.send_to_bing ? ' <span style="color: #f59e0b;">(No routing configured)</span>' : ''}
              </div>
            </div>
            <div style="display:flex;gap:8px;">
              <button class="action-btn action-btn-edit" onclick="editConfig(${c.id}, '${c.name}', '${c.event_name}', '${c.google_ads_event_name || ''}', '${c.conversion_action_id || ''}', '${c.facebook_event_name || ''}', '${c.bing_conversion_goal_id || ''}', ${c.send_to_bing ? 1 : 0})">Edit</button>
              <button class="action-btn action-btn-delete" onclick="deleteConfig(${c.id})">Delete</button>
            </div>
          </div>
        `).join('');
      }
    }

    // loadConversionActions removed - using text input now

    let editingConfigId = null;

    document.getElementById('addConfigForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const data = {
        name: document.getElementById('configName').value,
        event_name: document.getElementById('configEventName').value,
        google_ads_event_name: document.getElementById('configGoogleAdsEventName').value || null,
        conversion_action_id: document.getElementById('configConversionAction').value || null,
        facebook_event_name: document.getElementById('configFacebookEventName').value || null,
        bing_conversion_goal_id: document.getElementById('configBingConversionGoalId').value || null,
        send_to_bing: document.getElementById('configSendToBing').checked ? 1 : 0
      };

      const url = editingConfigId ? `/api/postback/config/${editingConfigId}` : '/api/postback/config';
      const method = editingConfigId ? 'PUT' : 'POST';

      const res = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      if (res.ok) {
        hideModal('addConfigModal');
        document.getElementById('addConfigForm').reset();
        editingConfigId = null;
        document.querySelector('#addConfigModal h2').textContent = 'Add Event Mapping';
        loadConfigs();
      } else {
        const err = await res.json();
        alert('Error: ' + err.error);
      }
    });

    function editConfig(id, name, eventName, googleAdsEventName, conversionActionId, facebookEventName, bingConversionGoalId, sendToBing) {
      editingConfigId = id;
      document.querySelector('#addConfigModal h2').textContent = 'Edit Event Mapping';
      document.getElementById('configName').value = name;
      document.getElementById('configEventName').value = eventName;
      document.getElementById('configGoogleAdsEventName').value = googleAdsEventName;
      document.getElementById('configConversionAction').value = conversionActionId;
      document.getElementById('configFacebookEventName').value = facebookEventName || '';
      document.getElementById('configBingConversionGoalId').value = bingConversionGoalId || '';
      document.getElementById('configSendToBing').checked = !!sendToBing;
      showModal('addConfigModal');
    }

    async function deleteConfig(id) {
      if (!confirm('Delete this event mapping?')) return;

      await fetch(`/api/postback/config/${id}`, { method: 'DELETE' });
      loadConfigs();
    }

    // Initialize
    loadPostbackUrl();
    loadEvents();
    loadConfigs();
  </script>
</body>
</html>
