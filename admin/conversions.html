<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Conversions | Coastal Debt CMS</title>
  <link rel="stylesheet" href="assets/css/style.css">
  <style>
    .postback-url {
      background: #f1f5f9;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-family: monospace;
      word-break: break-all;
    }
    .postback-url code {
      background: #1e293b;
      color: #22d3ee;
      padding: 8px 12px;
      border-radius: 4px;
      display: block;
      margin-top: 8px;
    }
    .copy-btn {
      background: #3052FF;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      margin-top: 8px;
    }
    .status-sent { color: #16a34a; }
    .status-failed { color: #dc2626; }
    .status-pending { color: #f59e0b; }
    .status-logged { color: #6b7280; }
    .tabs {
      display: flex;
      gap: 0;
      margin-bottom: 20px;
      border-bottom: 2px solid #e5e7eb;
    }
    .tab {
      padding: 12px 24px;
      border: none;
      background: none;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      color: #6b7280;
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
    }
    .tab.active {
      color: #3052FF;
      border-bottom-color: #3052FF;
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .event-config {
      background: #f9fafb;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .event-config .name { font-weight: 600; }
    .event-config .event-name {
      font-family: monospace;
      background: #e5e7eb;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 13px;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-logo">
        <img src="https://cdn.prod.website-files.com/6634aeab2fd552b666b69c25/68d3ea2a40971102ff6b605f_4df5ec858fd5062f2c7c25ddc701c00e_Coastal%20Debt%20Resolve_id2iMYK6Ad_1%201%20(1).svg" alt="Coastal Debt" style="height:36px;background:#fff;padding:8px 12px;border-radius:8px;">
      </div>
      <nav class="sidebar-nav">
        <a href="/admin/">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
          Dashboard
        </a>
        <a href="/admin/leads.html">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg>
          Leads
        </a>
        <a href="/admin/visitors.html">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
          Visitors
        </a>
        <a href="/admin/conversions.html" class="active">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
          Conversions
        </a>
        <a href="/admin/pages.html">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
          Landing Pages
        </a>
        <a href="/admin/forms.html">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M9 9h6M9 13h6M9 17h4"/></svg>
          Forms
        </a>
        <a href="/admin/scripts.html">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>
          Scripts
        </a>
        <a href="/admin/users.html">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
          Users
        </a>
        <a href="/admin/settings.html">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
          Settings
        </a>
      </nav>
      <div class="sidebar-footer">
        <div class="user-info">
          <div class="user-avatar" id="userAvatar">A</div>
          <div>
            <div class="user-name" id="userName">Admin</div>
            <div class="user-email" id="userEmail">admin@example.com</div>
          </div>
        </div>
        <button class="btn btn-secondary btn-small" onclick="logout()" style="width: 100%;">Logout</button>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <div class="page-header">
        <h1>Conversions & Postbacks</h1>
      </div>

      <!-- Postback URL Section -->
      <div class="card" style="margin-bottom: 20px;">
        <h3>Postback URL for Salesforce</h3>
        <p style="color: #6b7280; margin-bottom: 16px;">Use this URL in Salesforce to send conversion events back to your CMS.</p>

        <div class="postback-url">
          <strong>Postback URL:</strong>
          <code id="postbackUrl">Loading...</code>
          <button class="copy-btn" onclick="copyUrl()">Copy URL</button>
        </div>

        <div style="background: #f0fdf4; padding: 16px; border-radius: 8px; border: 1px solid #86efac;">
          <strong>Salesforce Setup:</strong>
          <ol style="margin: 12px 0 0 20px; color: #166534;">
            <li>In Salesforce, create a workflow rule or Process Builder flow</li>
            <li>When a lead status changes, make an HTTP POST to the postback URL</li>
            <li>Include: <code>eli_clickid={Lead.Eli_Click_ID__c}&event={status}&value={amount}</code></li>
          </ol>
        </div>
      </div>

      <!-- Tabs -->
      <div class="tabs">
        <button class="tab active" onclick="showTab('events')">Conversion Events</button>
        <button class="tab" onclick="showTab('config')">Event Configuration</button>
      </div>

      <!-- Events Tab -->
      <div id="tab-events" class="tab-content active">
        <div class="card">
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Lead</th>
                  <th>Event</th>
                  <th>Value</th>
                  <th>GCLID</th>
                  <th>Eli Click ID</th>
                  <th>Source</th>
                  <th>Status</th>
                  <th>Date</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="eventsTable">
                <tr><td colspan="9" class="loading"><div class="spinner"></div></td></tr>
              </tbody>
            </table>
          </div>
          <div id="eventsPagination" style="margin-top: 20px; display: flex; gap: 8px; justify-content: center;"></div>
        </div>
      </div>

      <!-- Config Tab -->
      <div id="tab-config" class="tab-content">
        <div class="card">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="margin: 0;">Event to Google Ads Mapping</h3>
            <button class="btn btn-primary" onclick="showModal('addConfigModal')">+ Add Event</button>
          </div>

          <p style="color: #6b7280; margin-bottom: 20px;">
            Map Salesforce events to Google Ads conversion actions. When a postback with a matching event name is received, it will be sent to Google Ads.
          </p>

          <div id="configList">
            <p class="empty-state">Loading...</p>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Add Config Modal -->
  <div class="modal-overlay" id="addConfigModal">
    <div class="modal">
      <div class="modal-header">
        <h2>Add Event Mapping</h2>
        <button class="modal-close" onclick="hideModal('addConfigModal')">&times;</button>
      </div>
      <form id="addConfigForm">
        <div class="form-group">
          <label>Display Name</label>
          <input type="text" id="configName" required placeholder="e.g., Lead Qualified">
        </div>
        <div class="form-group">
          <label>Event Name (from Salesforce)</label>
          <input type="text" id="configEventName" required placeholder="e.g., qualified">
          <small style="color: #666;">This must match the event name sent in the postback URL</small>
        </div>
        <div class="form-group">
          <label>Google Ads Conversion Action</label>
          <select id="configConversionAction">
            <option value="">-- Select (or configure in Settings first) --</option>
          </select>
          <small style="color: #666;">The conversion action to fire in Google Ads</small>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="hideModal('addConfigModal')">Cancel</button>
          <button type="submit" class="btn btn-primary">Save</button>
        </div>
      </form>
    </div>
  </div>

  <script src="assets/js/common.js"></script>
  <script>
    let currentEventsPage = 1;

    function showTab(tabName) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));

      document.querySelector(`.tab[onclick="showTab('${tabName}')"]`).classList.add('active');
      document.getElementById('tab-' + tabName).classList.add('active');
    }

    async function loadPostbackUrl() {
      const res = await fetch('/api/postback/url');
      const data = await res.json();
      document.getElementById('postbackUrl').textContent = data.postback_url;
    }

    function copyUrl() {
      const url = document.getElementById('postbackUrl').textContent;
      navigator.clipboard.writeText(url);
      alert('URL copied!');
    }

    async function loadEvents(page = 1) {
      currentEventsPage = page;
      const res = await fetch(`/api/postback/events?page=${page}&limit=25`);
      const data = await res.json();

      const tbody = document.getElementById('eventsTable');
      if (data.events.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="empty-state">No conversion events yet</td></tr>';
      } else {
        tbody.innerHTML = data.events.map(e => `
          <tr>
            <td>${e.full_name || e.email || '-'}</td>
            <td><strong>${e.conversion_action_name || '-'}</strong></td>
            <td>${e.conversion_value ? '$' + e.conversion_value : '-'}</td>
            <td style="font-size: 11px;">${e.gclid || '-'}</td>
            <td style="font-size: 11px;">${e.eli_clickid || '-'}</td>
            <td>${e.source}</td>
            <td><span class="status-${e.status}">${e.status}</span></td>
            <td>${formatDate(e.created_at)}</td>
            <td>
              ${e.status === 'failed' ? `<button class="action-btn action-btn-edit" onclick="retryEvent(${e.id})">Retry</button>` : ''}
            </td>
          </tr>
        `).join('');
      }

      // Pagination
      const pagination = document.getElementById('eventsPagination');
      pagination.innerHTML = '';
      for (let i = 1; i <= data.pagination.pages; i++) {
        const btn = document.createElement('button');
        btn.className = `btn btn-small ${i === currentEventsPage ? 'btn-primary' : 'btn-secondary'}`;
        btn.textContent = i;
        btn.onclick = () => loadEvents(i);
        pagination.appendChild(btn);
      }
    }

    async function retryEvent(id) {
      const res = await fetch(`/api/postback/events/${id}/retry`, { method: 'POST' });
      const data = await res.json();

      if (res.ok) {
        alert('Conversion sent to Google Ads!');
        loadEvents(currentEventsPage);
      } else {
        alert('Error: ' + data.error);
      }
    }

    async function loadConfigs() {
      const res = await fetch('/api/postback/config');
      const configs = await res.json();

      const container = document.getElementById('configList');
      if (configs.length === 0) {
        container.innerHTML = '<p class="empty-state">No event mappings configured. Add one to start sending conversions to Google Ads.</p>';
      } else {
        container.innerHTML = configs.map(c => `
          <div class="event-config">
            <div>
              <div class="name">${c.name}</div>
              <div style="margin-top: 4px;">
                Event: <span class="event-name">${c.event_name}</span>
                ${c.conversion_action_id ? ` â†’ Google Ads Action: ${c.conversion_action_id}` : ' <span style="color: #f59e0b;">(No Google Ads action)</span>'}
              </div>
            </div>
            <div>
              <button class="action-btn action-btn-delete" onclick="deleteConfig(${c.id})">Delete</button>
            </div>
          </div>
        `).join('');
      }
    }

    async function loadConversionActions() {
      try {
        const res = await fetch('/api/google-ads/conversion-actions');
        const data = await res.json();

        const select = document.getElementById('configConversionAction');
        if (data.actions && data.actions.length > 0) {
          select.innerHTML = '<option value="">-- Select --</option>' +
            data.actions.map(a => `<option value="${a.id}">${a.name}</option>`).join('');
        }
      } catch (e) {
        console.log('Could not load conversion actions - Google Ads may not be connected');
      }
    }

    document.getElementById('addConfigForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const data = {
        name: document.getElementById('configName').value,
        event_name: document.getElementById('configEventName').value,
        conversion_action_id: document.getElementById('configConversionAction').value || null
      };

      const res = await fetch('/api/postback/config', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      if (res.ok) {
        hideModal('addConfigModal');
        document.getElementById('addConfigForm').reset();
        loadConfigs();
      } else {
        const err = await res.json();
        alert('Error: ' + err.error);
      }
    });

    async function deleteConfig(id) {
      if (!confirm('Delete this event mapping?')) return;

      await fetch(`/api/postback/config/${id}`, { method: 'DELETE' });
      loadConfigs();
    }

    // Initialize
    loadPostbackUrl();
    loadEvents();
    loadConfigs();
    loadConversionActions();
  </script>
</body>
</html>
